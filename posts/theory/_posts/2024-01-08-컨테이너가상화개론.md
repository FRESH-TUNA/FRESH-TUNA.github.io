---
layout: post
title: "ì»¨í…Œì´ë„ˆ ê°€ìƒí™” ê°œë¡ "
tags: [linux, network, container]
comments: true
---
## Virtualization

ê°€ìƒí™”ëŠ” ì»´í“¨í„°ì˜ ìì›ì„ ì—¬ëŸ¬ ê°€ìƒë¨¸ì‹ ìœ¼ë¡œ ë‚˜ëˆ„ì–´ì„œ ìœ íœ´ìì›ì˜ ì´ìš©ë¥ ì„ ë†’ì´ê¸° ìœ„í•œ ì „ëµì´ë‹¤.

### Hypervisor ê°€ìƒí™”ë°©ì‹

ê°€ìƒí™”ê¸°ëŠ¥ì´ íƒ‘ì¬ëœ Hypervisor(type2)ë‚˜ hypervisor OS(type1)ì„ í†µí•´ ê²ŒìŠ¤íŠ¸ ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ë°©ì‹, ê´€ë¦¬ë¥¼ ìœ„í•œ ì»´í“¨í„°ë‚˜ ì½˜ì†”ì´ í•„ìš”í•˜ë‹¤.

ì „ê°€ìƒí™”(Full-Virtualization), IO ì‘ì—…ì„ OS ì°¨ì›ì˜ í•˜ì´í¼ì½œì„ í†µí•´ ì„±ëŠ¥ì„ ë†’ì¸ ë°˜ê°€ìƒí™”(Para-Virtualization) ë°©ì‹ì´ ì¡´ì¬í•œë‹¤.

ìµœê·¼ì—” ì „ê°€ìƒí™”ë‚˜ ë°˜ê°€ìƒí™”ì˜ ì„±ëŠ¥ì°¨ì´ê°€ ë§ì§€ ì•Šë‹¤ê³  í•œë‹¤.

### Container ê°€ìƒí™”

**ë¦¬ëˆ…ìŠ¤ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê¸°ìˆ , ìœ ë‹ˆì˜¨ ë§ˆìš´íŠ¸ë¥¼ ì§€ì›í•˜ëŠ” íŒŒì¼ì‹œìŠ¤í…œ (ë‹¤ë¥¸ OSëŠ” ë³„ë„ì˜ ê°€ìƒë¨¸ì‹  í•„ìš”)ì„ ì‚¬ìš©í•˜ì—¬ ì»´í“¨í„°ì˜ ìì›ì„ ë‚˜ëˆ„ëŠ”ê¸°ìˆ ì´ë‹¤.**

ì»¨í…Œì´ë„ˆëŠ” ë¦¬ëˆ…ìŠ¤ìƒì˜ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìˆëŠ” í”„ë¡œì„¸ìŠ¤ì¼ ë¿ì´ë¼ ì„±ëŠ¥ì´ ì¢‹ë‹¤.

ì»¨í…Œì´ë„ˆëŠ” ìƒˆ ì¸ìŠ¤í„´ìŠ¤ (í”„ë¡œì„¸ìŠ¤)ë¥¼ ì‹¤í–‰í•˜ë©´ ì»¨í…Œì´ë„ˆê°€ ì‚¬ë¼ì§€ê³  ì¬ì‹œì‘ ë˜ëŠ”ë°, ìƒì„±ëœ ì‹ ê·œ ì»¨í…Œì´ë„ˆëŠ” ì´ì „ ì»¨í…Œì´ë„ˆì™€ì˜ ì—°ê²°ëœ ìƒíƒœ ì •ë³´ê°€ ì—†ë‹¤. (ë¬´ìƒíƒœì„±)

## **ğŸŒ™Â ğŸŒ™Â ğŸŒ™Â ğŸŒ™**Â  ì»¨í…Œì´ë„ˆ ê¸°ë°˜ ê¸°ìˆ  **ğŸŒ™Â ğŸŒ™Â ğŸŒ™Â ğŸŒ™**

## cgroup (control group)

cgroupì€ í”„ë¡œì„¸ìŠ¤ê°€ ì‚¬ìš©í•˜ëŠ” ìì›ì„ ì œì–´í•˜ëŠ” íŒŒì¼ì‹œìŠ¤í…œìœ¼ë¡œ, ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ëª¨ë“ˆë¡œì„œ cpu, memory, device ì‚¬ìš©ì„ í”„ë¡œì„¸ìŠ¤ ê·¸ë£¹ë“¤ì— ëŒ€í•´ ì œí•œí• ìˆ˜ ìˆë‹¤. 

### ì„œë¸Œì‹œìŠ¤í…œ

íŠ¹ì • ìì›(ì˜ˆ: CPU, ë©”ëª¨ë¦¬)ì— ëŒ€í•œ cgroup ì œì–´ë¥¼ ë‹´ë‹¹

### ê³„ì¸µêµ¬ì¡°

- ìƒìœ„ ê³„ì¸µì—ì„œ ì„¤ì •í•œ ê·œì¹™ì´ í•˜ìœ„ ê³„ì¸µì— ìƒì†ëœë‹¤. ì´ë¥¼ í†µí•´ ìƒìœ„ ê³„ì¸µì´ ìì›ì„ í•˜ìœ„ ê³„ì¸µì— ë¶„ë°°í•˜ê±°ë‚˜ ì œì–´í•˜ëŠ” ì—­í™œì´ ê°€ëŠ¥í•˜ë‹¤
- ê³„ì¸µêµ¬ì¡°ì„ íŒŒì¼ì‹œìŠ¤í…œì˜ ë””ë ‰í† ë¦¬êµ¬ì¡°ë¡œ í‘œí˜„í•œë‹¤.
- ì—¬ëŸ¬ cgroup VFS ë§ˆìš´íŠ¸ ê°€ëŠ¥í•˜ë‹¤.

### ê³„ì¸µêµ¬ì¡° ì˜ˆì‹œ

```bash
# /sys/fs/cgroup
â”œâ”€â”€ cpu
â”‚   â”œâ”€â”€ my_group
â”‚   â”‚   â”œâ”€â”€ tasks
â”‚   â”‚   â”œâ”€â”€ cpu.cfs_quota_us 
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ other_group
â”‚   â”‚   â”œâ”€â”€ tasks
â”‚   â”‚   â”œâ”€â”€ 
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ ...
â”œâ”€â”€ memory
â”‚   â”œâ”€â”€ my_group
â”‚   â”‚   â”œâ”€â”€ tasks
â”‚   â”‚   â”œâ”€â”€ 
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ other_group
â”‚   â”‚   â”œâ”€â”€ tasks
â”‚   â”‚   â”œâ”€â”€ 
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ ...
â””â”€â”€ ...
```

- /sys/fs/cgroupëŠ” cgroup íŒŒì¼ ì‹œìŠ¤í…œì„ ë§ˆìš´íŠ¸í•œ ê²½ë¡œ
- cpu, memory ë“±ì€ ê°ê°ì˜ ì„œë¸Œì‹œìŠ¤í…œ(subsystem)
- my_group, other_group ë“±ì€ ê° ì„œë¸Œì‹œìŠ¤í…œ ë‚´ì—ì„œì˜ ê³„ì¸µ
    - í˜„ì¬ my_groupì˜ cpu ì‚¬ìš©ì œí•œì€ cpu.cfs_quota_us íŒŒì¼ë¡œ ì œì–´ë˜ê³  ìˆìŒ
- tasks íŒŒì¼ì—ëŠ” ê° ê·¸ë£¹ì— ì†í•œ í”„ë¡œì„¸ìŠ¤ë“¤ì˜ PIDë“¤ì´ ë‹´ê²¨ ìˆë‹¤

### cgroup ì‚¬ìš©ì˜ˆì œ

```bash
# my_group ë””ë ‰í„°ë¦¬ ìƒì„± (ì´ë¯¸ ìƒì„±ë˜ì–´ ìˆë‹¤ë©´ ìƒëµ)
mkdir /sys/fs/cgroup/cpu/my_group

# CPU ì‚¬ìš©ëŸ‰ ì œí•œ ì„¤ì • (ì˜ˆ: 20%)
echo 20 > /sys/fs/cgroup/cpu/my_group/cpu.cfs_quota_us

# CPU ì£¼ê¸° ì„¤ì • (ì˜ˆ: 100000us = 100ms)
echo 100000 > /sys/fs/cgroup/cpu/my_group/cpu.cfs_period_us

# my_groupì— í”„ë¡œì„¸ìŠ¤ í• ë‹¹
echo <PID_of_process> > /sys/fs/cgroup/cpu/my_group/tasks
```

## ë¦¬ëˆ…ìŠ¤ ë„¤ì„ìŠ¤í˜ì´ìŠ¤

ë¦¬ëˆ…ìŠ¤ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(Linux namespaces)ëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œ ìì²´ì ìœ¼ë¡œ ì§€ì›í•˜ëŠ” ê°€ìƒí™” ê¸°ë²•ì´ë‹¤.

ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” í”„ë¡œì„¸ìŠ¤ ê°„ì— ë¦¬ì†ŒìŠ¤ë¥¼ ê²©ë¦¬í•˜ê³ , ê°ê°ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œëŠ” ë¦¬ì†ŒìŠ¤ê°€ ê²©ë¦¬ëœ ê²ƒì²˜ëŸ¼ ë™ì‘í•˜ë„ë¡ í•œë‹¤. ë‹¤ì–‘í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë“¤ì´ ìˆìœ¼ë©°, ì£¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë“¤ì´ ì‚¬ìš©ëœë‹¤.

- **PID ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (pid):**
    - ê°ê°ì˜ í”„ë¡œì„¸ìŠ¤ì—ê²Œ ê³ ìœ í•œ í”„ë¡œì„¸ìŠ¤ ID(PID)ë¥¼ ë¶€ì—¬í•˜ë©°, ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì˜ í”„ë¡œì„¸ìŠ¤ëŠ” ì„œë¡œ ë‹¤ë¥¸ PIDë¥¼ ê°€ì§„ë‹¤. ë”°ë¼ì„œ í”„ë¡œì„¸ìŠ¤ ê°„ì—ëŠ” PIDê°€ ê²¹ì¹˜ì§€ ì•ŠëŠ”ë‹¤.
    - ë””í´íŠ¸ë¡œ ë¦¬ëˆ…ìŠ¤ì—ì„œëŠ” 1ë²ˆ í”„ë¡œì„¸ìŠ¤(init)ì— í• ë‹¹ë˜ì–´ìˆëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë“¤ì„ ìì‹ í”„ë¡œì„¸ìŠ¤ë“¤ì´ ëª¨ë‘ ê³µìœ í•´ì„œ ì‚¬ìš©í•˜ëŠ” êµ¬ì¡°ë¡œ ì´ë£¨ì–´ì ¸ìˆë‹¤.
- **ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (mnt):**
    - íŒŒì¼ ì‹œìŠ¤í…œì„ ê²©ë¦¬í•˜ë©°, ê°ê°ì˜ ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ë…ë¦½ì ì¸ íŒŒì¼ ì‹œìŠ¤í…œ ê³„ì¸µ êµ¬ì¡°ë¥¼ ê°€ì§„ë‹¤. 
    ë”°ë¼ì„œ ì„œë¡œ ë‹¤ë¥¸ ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì˜ í”„ë¡œì„¸ìŠ¤ëŠ” ì„œë¡œ ë‹¤ë¥¸ íŒŒì¼ ì‹œìŠ¤í…œì„ ë³¼ ìˆ˜ ìˆë‹¤.
- **ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (net):**
    - ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤, IP ì£¼ì†Œ, ë¼ìš°íŒ… í…Œì´ë¸” ë“±ì„ ê²©ë¦¬í•˜ë©°, ê°ê°ì˜ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ë…ë¦½ì ì¸ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì„ ê°€ì§„ë‹¤. ë”°ë¼ì„œ ì„œë¡œ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì˜ í”„ë¡œì„¸ìŠ¤ëŠ” ì„œë¡œ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì„ ê°€ì§„ë‹¤.
- **IPC ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (ipc):**
    - Inter-Process Communication(IPC) ë¦¬ì†ŒìŠ¤ë¥¼ ê²©ë¦¬í•œë‹¤. ì„œë¡œ ë‹¤ë¥¸ IPC ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì˜ í”„ë¡œì„¸ìŠ¤ëŠ” ë©”ì‹œì§€ í, ì„¸ë§ˆí¬ì–´ ë“±ê³¼ ê°™ì€ IPC ë©”ì»¤ë‹ˆì¦˜ì„ í†µí•´ í†µì‹ í•  ìˆ˜ ìˆë‹¤.
- **UTS ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (uts):**
    - í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œì˜ í˜¸ìŠ¤íŠ¸ ì´ë¦„ ë° ë„ë©”ì¸ ì´ë¦„ì„ ê²©ë¦¬í•œë‹¤. ê°ê°ì˜ UTS ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œëŠ” ë…ë¦½ëœ ì‹œìŠ¤í…œ ì‹ë³„ìë¥¼ ê°€ì§„ë‹¤.
- **ìœ ì € ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (user):**
    - ì‚¬ìš©ì ë° ê·¸ë£¹ IDë¥¼ ê²©ë¦¬í•œë‹¤. ê°ê°ì˜ ìœ ì € ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œëŠ” ì„œë¡œ ë‹¤ë¥¸ ì‚¬ìš©ì ë° ê·¸ë£¹ì„ ë‚˜íƒ€ë‚´ëŠ” IDê°€ ê²¹ì¹˜ì§€ ì•ŠëŠ”ë‹¤.
    - ìœ ì € ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ì¤‘ì²©ì´ ê°€ëŠ¥í•˜ë‹¤

### ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì˜ˆì œ

```bash
# 1ë²ˆ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³ ìœ  id
$ ls -al /proc/1/ns
total 0
dr-x--x--x 2 root root 0 Jan 31 03:47 .
dr-xr-xr-x 9 root root 0 Jan 24 14:46 ..
lrwxrwxrwx 1 root root 0 Jan 31 03:47 cgroup -> 'cgroup:[4026531835]'
lrwxrwxrwx 1 root root 0 Jan 31 03:47 ipc -> 'ipc:[4026531839]'
lrwxrwxrwx 1 root root 0 Jan 31 03:47 mnt -> 'mnt:[4026531840]'
lrwxrwxrwx 1 root root 0 Jan 31 03:47 net -> 'net:[4026531993]'
lrwxrwxrwx 1 root root 0 Jan 31 03:47 pid -> 'pid:[4026531836]'
lrwxrwxrwx 1 root root 0 Jan 31 03:47 pid_for_children -> 'pid:[4026531836]'
lrwxrwxrwx 1 root root 0 Jan 31 03:47 user -> 'user:[4026531837]'
lrwxrwxrwx 1 root root 0 Jan 31 03:47 uts -> 'uts:[4026531838]'

# namespaceë¥¼ ë§Œë“œëŠ” ì˜ˆì œ
# ìƒˆë¡œìš´ bash ì‰˜ì„ ì‹¤í–‰í•˜ë©´ ìƒˆë¡œìš´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë“¤ì„ ì ìš©í•œë‹¤.
# If program is not given, then "${SHELL}" is run (default: /bin/sh).
#
# fork ì˜µì…˜ì„ ì•ˆì£¼ë©´ execì„ í†µí•´ unshare í”„ë¡œì„¸ìŠ¤ê°€ bashë¡œ ëŒ€ì²´ë˜ì–´ ìƒˆë¡œìš´ pid ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ 1ë²ˆ í”„ë¡œì„¸ìŠ¤ê°€ ëœë‹¤.
unshare --mount --uts --ipc --net --pid --fork bash

# unshare processì™€ ìƒˆë¡œìš´ ì‰˜ í”„ë¡œì„¸ìŠ¤ê°€ bashë¡œë¶€í„° forkë˜ì–´ ì‹¤í–‰ë˜ì—ˆìŒì„ í™•ì¸í•œë‹¤.
# ìƒˆë¡œìš´ ì‰˜ í”„ë¡œì„¸ìŠ¤ ë²ˆí˜¸ í™•ì¸í›„ ë³€ê²½ëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
[root@ip-172-31-34-61 ~]# ps
    PID TTY          TIME CMD
   2540 pts/0    00:00:00 sudo
   2542 pts/0    00:00:00 bash
   2565 pts/0    00:00:00 unshare
   2568 pts/0    00:00:00 bash
   2796 pts/0    00:00:00 ps

[root@ip-172-31-34-61 ~]# ls -al /proc/2568/ns
total 0
dr-x--x--x. 2 root root 0 Jan  7 03:33 .
dr-xr-xr-x. 9 root root 0 Jan  7 03:27 ..
lrwxrwxrwx. 1 root root 0 Jan  7 03:33 cgroup -> 'cgroup:[4026531835]'
lrwxrwxrwx. 1 root root 0 Jan  7 03:33 ipc -> 'ipc:[4026532297]'
lrwxrwxrwx. 1 root root 0 Jan  7 03:33 mnt -> 'mnt:[4026532295]'
lrwxrwxrwx. 1 root root 0 Jan  7 03:33 net -> 'net:[4026532299]'
lrwxrwxrwx. 1 root root 0 Jan  7 03:33 pid -> 'pid:[4026532298]'
lrwxrwxrwx. 1 root root 0 Jan  7 03:33 pid_for_children -> 'pid:[4026532298]'
lrwxrwxrwx. 1 root root 0 Jan  7 03:33 time -> 'time:[4026531834]'
lrwxrwxrwx. 1 root root 0 Jan  7 03:33 time_for_children -> 'time:[4026531834]'
lrwxrwxrwx. 1 root root 0 Jan  7 03:33 user -> 'user:[4026531837]'
lrwxrwxrwx. 1 root root 0 Jan  7 03:33 uts -> 'uts:[4026532296]'

# hostname ì€ namespace ìƒì„±ì‹œ copyë˜ë¯€ë¡œ ì›í•˜ëŠ”ê°’ìœ¼ë¡œ ë³€ê²½í•œë‹¤.
# hostname ë³€ê²½í›„ ìƒˆë¡œìš´ ì‰˜ë¡œ execë¥¼ í†µí•´ í”„ë¡œì„¸ìŠ¤ë¥¼ ë®ì–´ì’¸ì–´ë²„ë¦°ë‹¤.
hostname tuna
exec bash
```

### unshare â€”fork option deepdive

â€”fork ì—†ì´ unshareë¥¼ ì‹¤í–‰í•˜ë©´ execì„ í†µí•´ bashëŠ” í˜„ì¬ "unshare" í”„ë¡œì„¸ìŠ¤ì™€ ë™ì¼í•œ pidë¥¼ ê°–ê²Œ ëœë‹¤.

unshare í”„ë¡œì„¸ìŠ¤ëŠ” ê³µìœ  í•´ì œ ì‹œìŠ¤í…œ í˜¸ì¶œì„ í˜¸ì¶œí•˜ê³  ìƒˆ pid ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ìƒì„±í•˜ì§€ë§Œ, í˜„ì¬ unshare í”„ë¡œì„¸ìŠ¤ëŠ” ìƒˆ pid ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì—†ë‹¤. ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„  í”„ë¡œì„¸ìŠ¤ Aê°€ ìƒˆ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ìƒì„±ì‹œ í”„ë¡œì„¸ìŠ¤ A ìì²´ëŠ” ìƒˆ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë„£ì§€ ì•Šê³  í”„ë¡œì„¸ìŠ¤ Aì˜ í•˜ìœ„ í”„ë¡œì„¸ìŠ¤ë§Œ ìƒˆ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë„£ëŠ”ë‹¤.

```bash
unshare -p /bin/bash
```

ì¦‰ bashì˜ ì²« ë²ˆì§¸ í•˜ìœ„ í”„ë¡œì„¸ìŠ¤ê°€ ìƒˆ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ PID 1ì´ ë˜ëŠ”ë°, í˜„ì¬ í•˜ìœ„í”„ë¡œì„¸ìŠ¤ê°€ ì—†ê±°ë‚˜ ì‹¤í–‰ë˜ì—ˆë‹¤ ì¢…ë£Œë˜ì–´ 1ë²ˆí”„ë¡œì„¸ìŠ¤ê°€ ì—†ëŠ” ìƒíƒœì¸ê²ƒì´ë‹¤.

PID 1 í”„ë¡œì„¸ìŠ¤ì—ëŠ” ëª¨ë“  ê³ ì•„ í”„ë¡œì„¸ìŠ¤ì˜ ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ê°€ ë˜ëŠ” íŠ¹ë³„í•œ ê¸°ëŠ¥ì´ ìˆë‹¤. ë£¨íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ PID 1 í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ë©´ ì»¤ë„ì€ íŒ¨ë‹‰ ìƒíƒœê°€ ëœë‹¤. íŠ¹ì • ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ PID 1 í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ë©´ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì€ disable_pid_allocation í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ í•´ë‹¹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ PIDNS_HASH_ADDING í”Œë˜ê·¸ë¥¼ ì •ë¦¬í•œë‹¤.

ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì´ ìƒˆ í”„ë¡œì„¸ìŠ¤ë¥¼ ìƒì„±í•  ë•Œ ì»¤ë„ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— PIDë¥¼ í• ë‹¹í•˜ê¸° ìœ„í•´ alloc_pid í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³ , PIDNS_HASH_ADDING í”Œë˜ê·¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° alloc_pid í•¨ìˆ˜ëŠ” -ENOMEM ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•œë‹¤. ì´ëŠ” "Cannot allocate memoryâ€ ë¥¼ ë°œìƒì‹œí‚¬ìˆ˜ ìˆë‹¤.

```bash
unshare --fork -p /bin/bash
```

â€”forkë¥¼ í†µí•´ unshare í”„ë¡œì„¸ìŠ¤ì—ì„œ /bin/bashë¥¼ exec í•˜ëŠ”ê²ƒì´ ì•„ë‹ˆë¼ fork í•œë‹¤. fork ëœ bash í”„ë¡œì„¸ìŠ¤ê°€ ì„¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ 1ë²ˆ í”„ë¡œì„¸ìŠ¤ê°€ ë˜ëŠ”ê²ƒì´ë‹¤.

## ìŠ¤ëƒ…ìƒ·ê³¼ ì»¨í…Œì´ë„ˆ

checkpointì„ ì§€ì •í•´ í•´ë‹¹ ì‹œì ì˜ ë°ì´í„°ë¥¼ ë³´ì¡´, ë³µêµ¬ë¥¼ ë•ëŠ” ê¸°ëŠ¥ì´ë‹¤.

ì‹¤ì œë¡œ Container ë‚´ë¶€ì—ì„œ Read, ìƒˆë¡œìš´ íŒŒì¼ì— ëŒ€í•œ Write, ê¸°ì¡´ íŒŒì¼ì— ëŒ€í•œ Writeì™€ ê°™ì€ ì‘ì—…ì´ ì¼ì–´ë‚˜ë©´ Storage Driverì— ë”°ë¼ì„œ Copy-on-Write (CoW) í˜¹ì€ Redirect-on-Write (RoW) ë°©ì‹ì˜ ìŠ¤ëƒ…ìƒ·ì„ ì‚¬ìš©í•œë‹¤.

ê·¸ë¦¬ê³  CoWì™€ RoWì—ì„œ ì‚¬ìš©ë˜ëŠ” ìŠ¤ëƒ…ìƒ·ë“¤ìœ„í•œ ì „ìš©ê³µê°„ Snapshot Poolì´ ìˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ Snapshotì€ Immutableí•œ ì†ì„±ìœ¼ë¡œ Read-Onlyì´ë‹¤. ë°˜ë©´Snapshot Poolì€ ì›ë³¸ë°ì´í„°ì— Write ì‹œì— ê¸°ì¡´ ë°ì´í„° ë³´ì¡´ì„ ìœ„í•´ ì´ìš©ë˜ëŠ”ë°, CoWì™€ RoWì— ë”°ë¼ì„œ ë™ì‘ë˜ëŠ” ê³¼ì •ì˜ ì°¨ì´ê°€ ìˆë‹¤.

ì»¨í…Œì´ë„ˆì˜ ìŠ¤í† ë¦¬ì§€ëŠ” ìŠ¤ëƒ…ìƒ·(ì²´í¬í¬ì¸íŠ¸)ë¥¼ cloneí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‘í•œë‹¤.

### COW (Copy on Write) ë°©ì‹ê³¼ ìŠ¤ëƒ…ìƒ·

COW ë°©ì‹ì—ì„œ íŒŒì¼ì„ ë³µì‚¬í•˜ë©´ íŒŒì¼ë“¤ ì „ì²´ ë³µì‚¬í•˜ëŠ”ê²ƒì´ ì•„ë‹ˆë¼ ì°¸ì¡°(ë˜í¼ëŸ°ìŠ¤) ë§Œí•œë‹¤. ì´í›„ ë³µì‚¬ëœ íŒŒì¼ì—ì„œ ë³€ê²½ì‚¬í•­ì´ ë°œìƒí•˜ë©´ ê·¸ë•Œì„œ ìƒˆë¡œìš´ íŒŒì¼ì„ ìƒì„±í•˜ê²Œ ëœë‹¤.

ì´ëŠ” ìŠ¤ëƒ…ìƒ·(ì´ë¯¸ì§€)ì„ ë§Œë“œëŠ” ê³¼ì •ê³¼ ìŠ¤ëƒ…ìƒ·ì˜ ë™ì‘ê³¼ì •ì—ì„œë„ ë˜‘ê°™ì´ ë™ì‘í•œë‹¤.

ìŠ¤ëƒ…ìƒ·ì„ ë§Œë“  ì´í›„ ê¸°ì¡´ íŒŒì¼ì— ëŒ€í•´ Write(ìˆ˜ì •) requestë¥¼ ë°›ê²Œ ëœë‹¤ë©´, ì›ë³¸ìœ¼ë¡œ ìœ ì§€ ì¤‘ì¸ íŒŒì¼ì„ ë³µì‚¬í•˜ì—¬ Snapshot Poolì— ë¨¼ì € ë³´ì¡´í•œë‹¤.

ì´ë¥¼ í†µí•´ ìŠ¤ëƒ…ìƒ·ì€ ì›ë³¸ ë°ì´í„°ë“¤ì„ ê·¸ëŒ€ë¡œ í¬ì¸íŒ…í• ìˆ˜ ìˆê³ , snapshot poolì— ë³´ì¡´ì´ ëë‚œí›„ ì›ë³¸ë°ì´í„°ì„ ìµœì‹  ë°ì´í„°ë“¤ë¡œ ê°±ì‹ í•œë‹¤.

COWëŠ” Write ìš”ì²­ì— ì˜í•œ ìˆ˜ì • ì‚¬í•­ ë°˜ì˜ ì‹œ Writeê°€ 2ë²ˆ(ê¸°ì¡´ ìŠ¤ëƒ…ìƒ·ì—ì„œ ë°ì´í„° ë³´ì¡´ + ì‹ ê·œ ë°ì´í„° ë°˜ì˜) ì§„í–‰ëœë‹¤. ì´ 2íšŒì˜ Writeë¥¼ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì— ì´ì— ëŒ€í•œ Overheadê°€ ìˆëŠ” í¸ì´ë‹¤.

CoWëŠ” write ì—ì„œ ì†í•´ë¥¼ ë³´ì§€ë§Œ Containerì˜ ìƒì„±(ìŠ¤ëƒ…ìƒ·ì„ ë³µì œí•˜ì—¬ íŒŒì¼ì‹œìŠ¤í…œìœ¼ë¡œ ë§ˆìš´íŠ¸)ê³¼ ì‚­ì œ ê°™ì€ ì‘ì—…ì€ ë¹ ë¥´ë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.

### ROW (Reference on write)ê³¼ ìŠ¤ëƒ…ìƒ·

RoWëŠ” Snapshotìœ¼ë¡œ ìœ ì§€í•˜ê³  ìˆëŠ” íŒŒì¼ì— ëŒ€í•´ Write ìš”ì²­ì„ ë°›ê²Œ ë˜ì—ˆì„ ë•Œ, ì›ë³¸ìœ¼ë¡œ ìœ ì§€ ì¤‘ì¸ íŒŒì¼ì„ ë³€ê²½í•  ìˆ˜ ì—†ë„ë¡ Freezeí•˜ê³  Snapshot Poolì— ìƒˆë¡œìš´ ë¸”ë¡ì„ í• ë‹¹ ë°›ì•„ ë³€ê²½ ì‚¬í•­ì„ ê¸°ë¡í•˜ê²Œ ëœë‹¤. 

Snapshot Poolì— ìœ ì§€í•˜ê³  ìˆëŠ” ë¸”ë¡ì—ëŠ” ë³€ê²½ëœ ë‚´ì—­ë§Œ diff íŒŒì¼ë¡œì¨ ì €ì¥í•œë‹¤.

RoWëŠ” 1íšŒì˜ Write ì‘ì—…ë§Œ ì´ë¤„ì§€ê³  ìˆ˜ì •ì‹œ CoWì²˜ëŸ¼ íŒŒì¼ì„ ë³µì‚¬ë¥¼ í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì—, ì„±ëŠ¥ë©´ì—ì„œëŠ” ì´ë“ì´ ìˆì„ìˆ˜ ìˆë‹¤.

í•˜ì§€ë§Œ ë³€ê²½ ì‚¬í•­ì— ëŒ€í•œ ë°˜ì˜ì„ ìœ„í•´ í•´ë‹¹ íŒŒì¼ì„ ì°¾ì„ë•Œ ì¶”ê°€ì ì¸ ì‹œê°„ì´ ìš”êµ¬ë˜ë¯€ë¡œ Containerì˜ ìƒì„±ê³¼ ì‚­ì œ ê°™ì€ ì‘ì—…ì´ ëŠë¦¬ë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.

### ìŠ¤ëƒ…ìƒ·ê³¼ ì»¨í…Œì´ë„ˆ

ê·¸ë¦¬ê³  Snapshotì´ Immutableì´ë¼ëŠ” ì ì„ ì—¼ë‘ì— ë‘ê³  ìœ„ì—ì„œ CoWì™€ RoWì— ëŒ€í•´ì„œ ë³´ì•˜ë“¯, ì›ë³¸ íŒŒì¼ì— ëŒ€í•œ Snapshotê³¼ snapshotì„ ë³µì œí•œ íŒŒì¼ì‹œìŠ¤í…œì´ ê°ê° Imageì™€ Containerì— ëŒ€ì‘ë˜ëŠ”ê²ƒìœ¼ë¡œ ì¶”ì¸¡ëœë‹¤.

### ì»¨í…Œì´ë„ˆì™€ inode limit

ì»¨í…Œì´ë„ˆê°€ ë§ì•„ì§ˆê²½ìš° íŒŒì¼ì— ëŒ€í•œ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆëŠ” inodeì˜ ê°¯ìˆ˜ê°€ ëª¨ìë¥¼ ê°€ëŠ¥ì„±ì´ ìˆë‹¤. ì´ë¥¼ ì˜ˆë°©í•˜ê¸° ìœ„í•´ ì»¤ë„ íŒŒë¼ë¯¸í„°ë¥¼ ìˆ˜ì •í•˜ëŠ”ê²ƒì„ ê³ ë ¤í•´ì•¼ í•œë‹¤.

### ìœ ë‹ˆì˜¨ íŒŒì¼ì‹œìŠ¤í…œ ì»¨ì…‰

ê·¸ë ‡ê²Œ ìŠ¤ëƒ…ìƒ·ì„ ì°¸ì¡°í•˜ì—¬ ì»¨í…Œì´ë„ˆë¥¼ ë§Œë“¤ê³  ê±°ê¸°ì„œ ìŠ¤ëƒ…ìƒ·ì„ ë˜ë§Œë“¤ê³  ë˜ë§Œë“œëŠ”ì¼ì´ ë°˜ë³µë ìˆ˜ ìˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ íŒŒì´ì¬ í™˜ê²½ì˜ ì´ë¯¸ì§€ë¥¼ ë§Œë“ í›„, íŒŒì´ì¬ ìŠ¤ëƒ…ìƒ·ì„ ê¸°ë°˜ìœ¼ë¡œ django ìš´ì˜ì„ ìœ„í•œ ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ê³ , django ìœ„ì— ìš°ë¦¬ê°€ ê°œë°œí•œ ì‹œìŠ¤í…œì„ ì˜¬ë¦¬ëŠ”ë“± ë§ì´ë‹¤.

ì´ë ‡ê²Œ ì—¬ëŸ¬ ë ˆì´ì–´ê°€ mergeë˜ì–´ì„œ í•˜ë‚˜ì˜ íŒŒì¼ì‹œìŠ¤í…œì´ ë˜ëŠ” ì»¨ì…‰ì„ ìœ ë‹ˆì˜¨ íŒŒì¼ì‹œìŠ¤í…œì´ë¼ í•˜ë©° ì»¨í…Œì´ë„ˆì˜ íŒŒì¼ì‹œìŠ¤í…œì˜ ê·¼ê°„ì´ë‹¤.

### Union FSì—ì„œ ë ˆì´ì–´(ìŠ¤ëƒ…ìƒ·) ìˆ˜ê°€ ë§ìœ¼ë©´ ìƒê¸°ëŠ” ë¬¸ì œ

ê°ê°ì˜ ë ˆì´ì–´ëŠ” ë¶€ëª¨ ë ˆì´ì–´ë¥¼ ì°¸ì¡°í•˜ê³  ìˆìœ¼ë¯€ë¡œ, ë ˆì´ì–´ê°€ ë§ê³  ì°¾ìœ¼ë ¤ëŠ” ë°ì´í„°ê°€ ë£¨íŠ¸ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì°¸ì¡°í•´ì•¼í•˜ëŠ” ë ˆì´ì–´ìˆ˜ê°€ ë§ì•„ì ¸ì„œ ì„±ëŠ¥ ì €í•˜ê°€ ë°œìƒí• ìˆ˜ ìˆë‹¤.

## ì£¼ìš” ìŠ¤í† ë¦¬ì§€ ë“œë¼ì´ë²„

### AUFS

AUFSëŠ” ê¸°ì¡´ì— ì„¤ëª…í–ˆë˜ Imageì™€ Containerì˜ êµ¬ì¡°ì™€ êµ‰ì¥íˆ ìœ ì‚¬í•˜ë‹¤. mountëœ ContainerëŠ” Union Mount Pointì— ì¡´ì¬í•˜ëŠ” Imageë“¤ì„ ì½ê¸°ì „ìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.

Containerë¥¼ ì‚¬ìš©í•˜ë©´ì„œ Read-Onlyë¡œë§Œ ìˆ˜í–‰ë˜ëŠ” íŒŒì¼ì— ëŒ€í•´ì„œ ë³€ê²½ì„ í•´ì•¼í•  ë•Œ AUFSëŠ” CoW ë°©ì‹ìœ¼ë¡œ Writeë¥¼ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì—, í•´ë‹¹ íŒŒì¼ ì „ì²´ë¥¼ Containerì˜ Layerë¡œ ë³µì‚¬í•˜ê³  ë³µì‚¬ëœ íŒŒì¼ì„ ë³€ê²½í•˜ëŠ” ì‹ìœ¼ë¡œ Writeë¥¼ ìˆ˜í–‰í•œë‹¤. 

íŒŒì¼ì— ëŒ€í•´ì„œ ë³€ê²½í•  ë•Œ ì›ë³¸ íŒŒì¼ ì „ì²´ë¥¼ Containerì˜ Layerë¡œ ë³µì‚¬í•´ì•¼ í•˜ë¯€ë¡œ, ë³µì‚¬í•  íŒŒì¼ì„ ì°¾ì•„ë‚´ëŠ” ê³¼ì •ì´ í•„ìš”í•˜ë‹¤.

ì´ ë•Œ AUFSëŠ” íŒŒì¼ì„ Imageì˜ ê°€ì¥ ìœ„ ìª½ì— ì¡´ì¬í•˜ëŠ” Layerë¶€í„° ì•„ë˜ ìª½ìœ¼ë¡œ íŒŒì¼ì„ ì°¾ì•„ë‚¸ë‹¤.

ë”°ë¼ì„œ ì°¾ìœ¼ë ¤ëŠ” íŒŒì¼ì´ ê°€ì¥ ì•„ë˜ ìª½ Layerì— ì¡´ì¬í•œë‹¤ë©´ Writeì— ê±¸ë¦¬ëŠ” ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìœ¼ë©°, ë”êµ°ë‹¤ë‚˜ Writeë¥¼ ìˆ˜í–‰í•˜ë ¤ëŠ” íŒŒì¼ì˜ í¬ê¸°ê°€ í¬ë‹¤ë©´ ê·¸ë§Œí¼ ë³µì‚¬í•˜ëŠ”ë° ì‹œê°„ì´ ë” ê±¸ë¦´ ìˆ˜ ìˆë‹¤.

ì´ì— ëŒ€í•´ì„  íŒŒì¼ì„ ë³€ê²½í•˜ë ¤ê³  í•  ë•Œ ìµœì´ˆ 1íšŒì— ëŒ€í•´ì„œë§Œ íŒŒì¼ì„ ë³µì‚¬í•˜ê¸° ë•Œë¬¸ì—, í•´ë‹¹ íŒŒì¼ì„ ì—¬ëŸ¬ ì°¨ë¡€ ë³€ê²½í•˜ì—¬ Writeí•  ë•ŒëŠ” ê¸°ì¡´ì— ë³µì‚¬ëœ íŒŒì¼ì„ ì´ìš©í•œë‹¤.

### Overlay2

ë‹¤ë¥¸ Storage Driverë“¤ê³¼ ë‹¬ë¦¬ ë‹¨ì¼í™”ëœ Imageì˜ Layerë¡œ êµ¬ì„±ëœë‹¤. ì´ ë•Œë¬¸ì— AUFS ë³´ë‹¤ ì¡°ê¸ˆ ë” ë‚˜ì€ ì„±ëŠ¥ì„ ë³´ì¸ë‹¤.

CoW ë°©ì‹ìœ¼ë¡œ Writeë¥¼ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì— Containerì˜ ìƒì„±ê³¼ ì‚­ì œì— ëŒ€í•œ ì‘ì—…ì´ ë¹¨ë¼ PaaS (Platform as a Service)ì— ì í•©í•œ Storage Driverì´ë‹¤.

Containerì˜ Storage ì œí•œì— ëŒ€í•œ ì„¤ì •ì´ ê°€ëŠ¥í•˜ë‹¤. ë‹¤ë§Œ ë°©ë²•ì´ ê¹Œë‹¤ë¡œìš´ë° ê°„ë‹¨íˆ ìš”ì•½í•˜ë©´, Storage Driverë¥¼ OverlayFSë¡œ ì´ìš©í•˜ë©´ì„œ Dockerì— ëŒ€í•œ ë°ì´í„°ê°€ xfsì— ì €ì¥ë˜ì–´ ìˆëŠ” ê²½ìš°ì— xfsì˜ project quotaë¼ëŠ” ê¸°ëŠ¥ì„ í†µí•´ Containerì˜ Storage ì œí•œì´ ê°€ëŠ¥í•˜ë‹¤.

```bash
# ubuntu image layers

$ ls -l /var/lib/docker/overlay2

total 24
drwx------ 5 root root 4096 Jun 20 07:36 223c2864175491657d238e2664251df13b63adb8d050924fd1bfcdb278b866f7
drwx------ 3 root root 4096 Jun 20 07:36 3a36935c9df35472229c57f4a27105a136f5e4dbef0f87905b2e506e494e348b
drwx------ 5 root root 4096 Jun 20 07:36 4e9fa83caff3e8f4cc83693fa407a4a9fac9573deaf481506c102d484dd1e6a1
drwx------ 5 root root 4096 Jun 20 07:36 e8876a226237217ec61c4baf238a32992291d059fdac95ed6303bdff3f59cff5
drwx------ 5 root root 4096 Jun 20 07:36 eca1e4e1694283e001f200a667bb3cb40853cf2d1b12c29feda7422fed78afed
drwx------ 2 root root 4096 Jun 20 07:36 l

$ ls -l /var/lib/docker/overlay2/l

total 20
lrwxrwxrwx 1 root root 72 Jun 20 07:36 6Y5IM2XC7TSNIJZZFLJCS6I4I4 -> ../3a36935c9df35472229c57f4a27105a136f5e4dbef0f87905b2e506e494e348b/diff
lrwxrwxrwx 1 root root 72 Jun 20 07:36 B3WWEFKBG3PLLV737KZFIASSW7 -> ../4e9fa83caff3e8f4cc83693fa407a4a9fac9573deaf481506c102d484dd1e6a1/diff
lrwxrwxrwx 1 root root 72 Jun 20 07:36 JEYMODZYFCZFYSDABYXD5MF6YO -> ../eca1e4e1694283e001f200a667bb3cb40853cf2d1b12c29feda7422fed78afed/diff
lrwxrwxrwx 1 root root 72 Jun 20 07:36 NFYKDW6APBCCUCTOUSYDH4DXAT -> ../223c2864175491657d238e2664251df13b63adb8d050924fd1bfcdb278b866f7/diff
lrwxrwxrwx 1 root root 72 Jun 20 07:36 UL2MW33MSE3Q5VYIKBRN4ZAGQP -> ../e8876a226237217ec61c4baf238a32992291d059fdac95ed6303bdff3f59cff5/diff
```

```bash
# lowest layer

$ ls /var/lib/docker/overlay2/3a36935c9df35472229c57f4a27105a136f5e4dbef0f87905b2e506e494e348b/

diff  link

$ cat /var/lib/docker/overlay2/3a36935c9df35472229c57f4a27105a136f5e4dbef0f87905b2e506e494e348b/link

6Y5IM2XC7TSNIJZZFLJCS6I4I4

$ ls  /var/lib/docker/overlay2/3a36935c9df35472229c57f4a27105a136f5e4dbef0f87905b2e506e494e348b/diff

bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
```

```bash
# second lowest layer

$ ls /var/lib/docker/overlay2/223c2864175491657d238e2664251df13b63adb8d050924fd1bfcdb278b866f7

diff  link  lower  merged  work

$ cat /var/lib/docker/overlay2/223c2864175491657d238e2664251df13b63adb8d050924fd1bfcdb278b866f7/lower

l/6Y5IM2XC7TSNIJZZFLJCS6I4I4

$ ls /var/lib/docker/overlay2/223c2864175491657d238e2664251df13b63adb8d050924fd1bfcdb278b866f7/diff/

etc  sbin  usr  var
```

### Devicemapper

ë ˆë“œí–‡ ê³„ì—´ì˜ Linuxì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë§Œë“¤ì–´ì§„ Storage Driverì´ë‹¤. RoW ë°©ì‹ìœ¼ë¡œ Writeë¥¼ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ìœ¼ë¡œ ì´ë“ì„ ë³¼ ìˆ˜ ìˆì§€ë§Œ, Containerì˜ ìƒì„±ê³¼ ì‚­ì œì— ëŒ€í•œ ì‘ì—…ì´ ëŠë¦° í¸ì´ë‹¤.

CentOSì™€ ê°™ì€ ìš´ì˜ì²´ì œì—ì„œ ì£¼ë¡œ ì‚¬ìš©í–ˆì§€ë§Œ, ì„±ëŠ¥ì´ ì¢‹ì§€ ì•Šì•„ Deprecatedëœ Storage Driverì´ë‹¤. ë”°ë¼ì„œ Docker Engine ë²„ì „ 1.13.0 ì´ì „ìœ¼ë¡œëŠ” Devicemapperë¥¼, ì´í›„ë¡œëŠ” OverlayFSë¥¼ ê¸°ë³¸ Storage Driverë¡œ ì´ìš©í•œë‹¤.

## ì»¨í…Œì´ë„ˆ ì‹¤ìŠµ

### **íŒŒì¼ì‹œìŠ¤í…œ(zfs)ë¥¼ ì´ìš©í•˜ì—¬ íŒŒí‹°ì…˜(ì´ë¯¸ì§€) ìƒì„±**

**ì´ë¯¸ì§€(ìŠ¤ëƒ…ìƒ·)ì„ ë§Œë“¤ zfs íŒŒì¼ì‹œìŠ¤í…œì„ ë§Œë“¤ì–´ì¤€ë‹¤.**

```bash
# zfs ë° ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ë„êµ¬ ì„¤ì¹˜
# ìš°ë¶„íˆ¬ ê¸°ì¤€
apt install zfsutils-linux
apt install stress

# ì¤€ë¹„ëœ íŒŒí‹°ì…˜ìœ¼ë¡œ zpool ìƒì„±
zpool create zpools /dev/sda5

# ì´ë¯¸ì§€ë¥¼ ìœ„í•œ zfs íŒŒì¼ì‹œìŠ¤í…œ ìƒì„± & ë§ˆìš´íŠ¸
zfs create zpools/images -o mountpoint=/zpools/images
zfs create zpools/images/myImage -o mountpoint=/zpools/images/myImage

# í…ŒìŠ¤íŠ¸ì— í•„ìš”í•œ ìœ í‹¸ë“¤ì„ ì´ë¯¸ì§€ê°€ ë  íŒŒì¼ì‹œìŠ¤í…œì— ë³µì‚¬
# í™˜ê²½ë§ˆë‹¤ /bin, /libì„ ë‹¤ë£¨ëŠ” ë°©ì‹ì´ ë‹¤ë¥¼ìˆ˜ ìˆì–´ í™•ì¸í›„ ì‚¬ìš©
mkdir /zpools/images/myImage/bin
mkdir /zpools/images/myImage/usr
mkdir /zpools/images/myImage/usr/bin

cd /zpools/images/myImage/bin

cp /bin/mount /bin/umount /bin/df /bin/lsblk .
cp /bin/ls /bin/mkdir /bin/rm .
cp /bin/ping /bin/ip .
cp /bin/ps .
cp /bin/stress.

# usr/binì„ ì°¾ì•„ê°€ëŠ” ê²½ìš°ë„ ìˆì–´ì„œ ë¯¸ë¦¬ ì˜ˆë°©
cd /zpools/images/myImage
cp bin/* usr/bin*

# í…ŒìŠ¤íŠ¸ì— í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ë¯¸ì§€ê°€ ë  íŒŒì¼ì‹œìŠ¤í…œì— ë³µì‚¬
# í™˜ê²½ë§ˆë‹¤ /bin, /libì„ ë‹¤ë£¨ëŠ” ë°©ì‹ì´ ë‹¤ë¥¼ìˆ˜ ìˆì–´ í™•ì¸í›„ ì‚¬ìš©
cp -r /lib /zpools/images/myImage/lib
cp -r /usr/lib /zpools/images/myImage/usr/lib
cp -r /usr/lib64 /zpools/images/myImage/usr/lib64

root@ip-172-31-42-199:~# ls /zpools/images/myImage/
ls  ping  ps
```

**íŒŒì¼ì‹œìŠ¤í…œìœ¼ë¡œ ë¶€í„° ì´ë¯¸ì§€ë¥¼ ë§Œë“ í›„ ì»¨í…Œì´ë„ˆë¥¼ ìœ„í•œ íŒŒì¼ì‹œìŠ¤í…œì„ ìƒì„±í•œë‹¤.**

```bash
# snapshot ìƒì„± (ë¶„ê¸°ë¥¼ ë§Œë“¤ê¸° ìœ„í•œ read-only í¬ì¸íŠ¸ ìƒì„±)
zfs snapshot zpools/images/myImage@v1.0

# clone ìƒì„± (ì»¨í…Œì´ë„ˆ ìƒì„±)
zfs create zpools/containers -o mountpoint=/zpools/containers
zfs clone zpools/images/myImage@v1.0 zpools/containers/myContainer

# ì»¨í…Œì´ë„ˆì•ˆì˜ íŒŒì¼ í™•ì¸
root@tuna:~# ls /zpools/containers/myContainer/
bin  lib  lib64  ls  usr

# ì»¨í…Œì´ë„ˆì—ì„œ ì‹¤ì œ USEDëœ ìš©ëŸ‰ì€ 62K (copy on write)
root@tuna:~# zfs list
NAME                            USED  AVAIL     REFER  MOUNTPOINT
zpools                          605M  3.03G       24K  /zpools
zpools/containers                86K  3.03G       24K  /zpools/containers
**zpools/containers/myContainer    62K  3.03G      605M  /zpools/containers/myContainer**
zpools/images                   605M  3.03G       24K  /zpools/images
zpools/images/myImage           605M  3.03G      605M  /zpools/images/myImage
```

### ì»¨í…Œì´ë„ˆë¥¼ ìœ„í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±

```bash
# namespaceë¥¼ ë§Œë“¤ì–´ì£¼ì–´ì•¼ í•œë‹¤.
unshare --mount --uts --ipc --net --pid --cgroup --fork bash

# hostname ì€ namespace ìƒì„±ì‹œ copyë˜ë¯€ë¡œ ì›í•˜ëŠ”ê°’ìœ¼ë¡œ ë³€ê²½
# execì„ í†µí•´ ì„¸ì…˜ì´ ë¶„ë¦¬ë˜ì–´ ì˜í–¥ ìµœì†Œí™”
hostname tuna
exec bash
```

### pivot root ì™€ proc íŒŒì¼ì‹œìŠ¤í…œ ë§ˆìš´íŠ¸

**ìƒˆë¡œìš´ ë£¨íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œê³¼ ì´ì „ ë£¨íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œ ê°„ì˜ ë¶„ë¦¬í•œë‹¤.**

**`pivot_root`**ë¥¼ ì‚¬ìš©í•˜ë©´ í˜„ì¬ì˜ ë£¨íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œê³¼ ìƒˆë¡œìš´ ë£¨íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì„ êµì²´í•œë‹¤.

**`oldroot`** ë””ë ‰í„°ë¦¬ë¥¼ ë§Œë“¤ì–´ì„œ ì´ì „ ë£¨íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì„ ì„ì‹œë¡œ ë§ˆìš´íŠ¸í•˜ë©´, ì´ì „ ë£¨íŠ¸ì™€ ìƒˆë¡œìš´ ë£¨íŠ¸ë¥¼ ì„œë¡œ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤. 

ì´ë ‡ê²Œ í•¨ìœ¼ë¡œì¨ ìƒˆë¡œìš´ ë£¨íŠ¸ë¡œ ì „í™˜ë˜ë”ë¼ë„ ì´ì „ ë£¨íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì„ ì•ˆì „í•˜ê²Œ ìœ ì§€í•˜ë©´ì„œ í•„ìš”ì— ë”°ë¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. 

ë‹¤ë§Œ ì»¨í…Œì´ë„ˆì—ì„  oldrootê°€ í•„ìš”ì—†ê³ , ë³´ì•ˆìƒ ë¬¸ì œë„ ë˜ë¯€ë¡œ ë°”ë¡œ umountí•´ë²„ë¦°ë‹¤.

chroot ëª…ë ¹ì€ ë³´ì•ˆìƒ ë¬¸ì œë¡œ ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

```bash
# mount namespace ì—­ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ copyë˜ë¯€ë¡œ ë‹¤ë¥¸ ë””ë ‰í† ë¦¬ì— ì ‘ê·¼ì´ ê°€ëŠ¥
# ì»¨í…Œì´ë„ˆ ë””ë ‰í† ë¦¬ë¥¼ root ë””ë ‰í† ë¦¬ë¡œ ë³€ê²½
# exec chroot . /bin/sh ëŠ” ë³´ì•ˆìƒì˜ ë¬¸ì œë¡œ ì“°ì§€ ì•ŠëŠ”ë‹¤.
cd /zpools/containers/myContainer/
mkdir oldroot
pivot_root . oldroot

# ls
bin  dev  etc  home  lib  media  mnt  proc  root  
run  sbin  srv  sys  tmp  usr  var oldroot

# current namespaceì˜ proc filesystem ì„ ìƒˆë¡œ ë§ˆìš´íŠ¸ í•´ì¤€ë‹¤.
# ìƒˆë¡œìš´ pid ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ëŒ€í•œ proc íŒŒì¼ ì‹œìŠ¤í…œì´ ë§ˆìš´íŠ¸ ëœë‹¤.
# í•„ìš”ì‹œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ì˜í•´ ê²©ë¦¬ëœ cgroup íŒŒì¼ì‹œìŠ¤í…œë„ ë§ˆìš´íŠ¸í• ìˆ˜ ìˆë‹¤.
mkdir proc
mount -t proc proc /proc

# í˜„ì¬ ì‰˜ì˜ pidê°€ 1ë²ˆì¸ê²ƒì„ í™•ì¸
root@tuna:/# ps
    PID TTY          TIME CMD
      1 ?        00:00:00 bash
     39 ?        00:00:00 ps
root@tuna:/# echo $$
1

# old rootëŠ” í•„ìš”ì—†ìœ¼ë¯€ë¡œ unmount ì‹œì¼œë²„ë¦°ë‹¤.
umount -l /oldroot

# mount ì •ë³´ í™•ì¸
root@tuna:/# df -h
Filesystem                     Size  Used Avail Use% Mounted on
zpools/containers/myContainer  3.7G  611M  3.1G  17% /

root@tuna:/# mount
zpools/containers/myContainer on / type zfs (rw,xattr,noacl)
proc on /proc type proc (rw,relatime)
```

### ì»¨í…Œì´ë„ˆë¥¼ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ê°€ìƒí™”

**ë‹¤ë¥¸ SHELLì„ ì‹¤í–‰í•˜ì—¬ ì»¨í…Œì´ë„ˆë¥¼ ìœ„í•œ network interfaceë¥¼ ë§Œë“ ë‹¤**

```bash
# ë‹¤ë¥¸ ì‰˜ì„ ì‹¤í–‰í•˜ì—¬ ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì¶”ê°€í•œë‹¤.
# peer name ì˜µì…˜ì„ ì£¼ë©´ ì¸í„°í˜ì´ìŠ¤ê°€ í•˜ë‚˜ ë”ìƒì„±ëœë‹¤.
# ë‘ ì¸í„°í˜ì´ìŠ¤ëŠ” ì„œë¡œ ì—°ê²°ë˜ì–´ í†µì‹ ì´ ê°€ëŠ¥
# í•˜ë‚˜ëŠ” í˜¸ìŠ¤íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤, í•˜ë‚˜ëŠ” ì»¨í…Œì´ë„ˆ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì‚¬ìš©í•  ì˜ˆì •ì´ë‹¤.
CPID=$(pidof unshare)
ip link add name h$CPID type veth peer name c$CPID

root@ip-172-31-42-199:~# ip addr
......
3: c1632@h1632: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether f6:57:fc:69:7b:ff brd ff:ff:ff:ff:ff:ff
4: h1632@c1632: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether b6:ba:dc:e5:12:2f brd ff:ff:ff:ff:ff:ff

# ë‘˜ì¤‘ í•˜ë‚˜ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ê²©ë¦¬ëœ network ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì„¤ì •
ip link set c$CPID netns $CPID

# ì»¨í…Œì´ë„ˆì˜ ì‰˜ë¡œ ëŒì•„ê°€ ip addrë¡œ í™•ì¸í•´ë³´ì!
root@tuna:/# ip addr
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
3: c1632@if4: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether f6:57:fc:69:7b:ff brd ff:ff:ff:ff:ff:ff link-netnsid 0
```

**ì¸í„°í˜ì´ìŠ¤ë“¤ì— í†µì‹ ì„ ìœ„í•œ ì‚¬ì„¤ì£¼ì†Œ ë¶€ì—¬**

```bash
# hostìš© ì¸í„°í˜ì´ìŠ¤ì— ì‚¬ì„¤ì£¼ì†Œ ë¶€ì—¬
# ì‚¬ì„¤ ëŒ€ì—­ì€ 172.17.0.1/16 ë¥¼ ì‚¬ìš©í•œë‹¤.
# ë¸Œë¦¿ì§€ ì¥ì¹˜ë¥¼ ì‚¬ìš©í•˜ë©´ í•˜ë‚˜ì˜ ë¸Œë¦¿ì§€ë¡œ ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆì˜ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬ì„±í•˜ëŠ”ê²ƒì´ ê°€ëŠ¥
ip addr add 172.17.0.1/16 dev h$CPID
ip link set dev h$CPID up

root@tuna:/# ip link
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
3: c1632@if4: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether f6:57:fc:69:7b:ff brd ff:ff:ff:ff:ff:ff link-netnsid 0

# ì»¨í…Œì´ë„ˆì˜ í„°ë¯¸ë„ì—ì„œ, ìƒˆë¡œë§Œë“  ì¸í„°í˜ì´ìŠ¤ í™œì„±í™” ì‘ì—…ì´ í•„ìš”í•˜ë‹¤.
# ipì£¼ì†Œ í• ë‹¹, default route ì„¤ì •, up ì„ ì§„í–‰í•œë‹¤.
# c1632 ëŠ” ì—”í„°í˜ì´ìŠ¤ì˜ ì´ë¦„ì¸ë°, eth0 ë¡œ ë°”ê¿”ì¤€ë‹¤.
# ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì€ ê°™ì´ ë§ì¶°ì¤€ë‹¤. (172.17.0.1/16)
ip link set dev lo up
ip link set c1632 name eth0 up
ip addr add 172.17.0.2/16 dev eth0
# ip route add default via 172.17.0.1

# ì»¨í…Œì´ë„ˆì—ì„œ í˜¸ìŠ¤íŠ¸ë¡œ ping í…ŒìŠ¤íŠ¸
root@tuna:/# ping 172.17.0.1
PING 172.17.0.1 (172.17.0.1) 56(84) bytes of data.
64 bytes from 172.17.0.1: icmp_seq=1 ttl=64 time=0.053 ms
64 bytes from 172.17.0.1: icmp_seq=2 ttl=64 time=0.035 ms
```

**(ì˜µì…˜)** **ì»¨í…Œì´ë„ˆì— ì¸í„°ë„· í†µì‹  ê¸°ëŠ¥ ë¶€ì—¬í•˜ê¸°**

```bash
# í˜¸ìŠ¤íŠ¸ì˜ í„°ë¯¸ë„ì—ì„œ 172.17.0.1/16 ëŒ€ì—­ì—ì„œ ê³µì¸IPë¡œì˜ nat ê·œì¹™ ì¶”ê°€
sysctl -w net.ipv4.ip_forward=1
iptables -t nat -A POSTROUTING -s 172.17.0.1/16 -j MASQUERADE

# ì»¨í…Œì´ë„ˆì˜ í„°ë¯¸ë„ì—ì„œ, ë””í´íŠ¸ ê²Œì´íŠ¸ì›¨ì´ ì¶”ê°€
ip route add default via 172.17.0.1

# êµ¬ê¸€ dns ê³µì¸ ipì£¼ì†Œë¡œ ping í•´ë³´ê¸°
root@tuna:/# ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=103 time=29.2 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=103 time=29.3 ms
```

### cgroupì„ í†µí•´ ì»¨í…Œì´ë„ˆì˜ ìì› ì œí•œ

**í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œì—ì„œ cgroup ì— myContainer ê·¸ë£¹ ìƒì„±í•˜ê¸°**

```bash
# cgroup ì‘ì„±ì„ ë„ì™€ì£¼ëŠ” íˆ´
apt install -y cgroup-tools

root@ip-172-31-42-199:~# cgcreate -a root -g cpu:myContainer
root@ip-172-31-42-199:~# cgcreate -a root -g memory:myContainer

root@ip-172-31-42-199:~# ls /sys/fs/cgroup/myContainer/
cgroup.controllers      cpu.max.burst          io.prio.class        memory.reclaim
cgroup.events           cpu.pressure           io.stat              memory.stat
cgroup.freeze           cpu.stat               io.weight            memory.swap.current
cgroup.kill             cpu.uclamp.max         memory.current       memory.swap.events
cgroup.max.depth        cpu.uclamp.min         memory.events        memory.swap.high
cgroup.max.descendants  cpu.weight             memory.events.local  memory.swap.max
cgroup.pressure         cpu.weight.nice        memory.high          memory.zswap.current
cgroup.procs            cpuset.cpus            memory.low           memory.zswap.max
cgroup.stat             cpuset.cpus.effective  memory.max           pids.current
cgroup.subtree_control  cpuset.cpus.partition  memory.min           pids.events
cgroup.threads          cpuset.mems            memory.numa_stat     pids.max
cgroup.type             cpuset.mems.effective  memory.oom.group     pids.peak
cpu.idle                io.max                 memory.peak
cpu.max                 io.pressure            memory.pressure

# myContainer ê·¸ë£¹ì˜ í”„ë¡œì„¸ìŠ¤ë“¤ì€ cpu 20%, mem 200MBë¡œ ì œí•œëœë‹¤.
echo 20000 > /sys/fs/cgroup/myContainer/cpu.max
echo 209715200 > /sys/fs/cgroup/myContainer/memory.max
```

**ì»¨í…Œì´ë„ˆì˜ í˜¸ìŠ¤íŠ¸ ê¸°ì¤€ PIDë¥¼ myContainer ê·¸ë£¹ì— ì¶”ê°€**

```bash
# ì»¨í…Œì´ë„ˆì˜ í˜¸ìŠ¤íŠ¸ ê¸°ì¤€ pidì¡°íšŒ
root@ip-172-31-42-199:~# ps -a
    PID TTY          TIME CMD
   1465 pts/1    00:00:00 bash
   1632 pts/1    00:00:00 unshare
   **1633 pts/1    00:00:00 bash**
   1814 pts/3    00:00:00 bash
   2707 pts/3    00:00:00 ps

# cgroupì˜ myContainer ê·¸ë£¹ì˜ cpu, memory ì„œë¸Œì‹œìŠ¤í…œì— pidì¶”ê°€
# í˜¸ìŠ¤íŠ¸ ê¸°ì¤€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œì˜ ì»¨í…Œì´ë„ˆ pid
sudo cgclassify -g cpu,memory:myContainer 1633
```

**ì»¨í…Œì´ë„ˆ ë¶€í•˜í…ŒìŠ¤íŠ¸**

```bash
# ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œ cpu ë¶€í•˜ ì‹œì‘
stress -c 1

# host í™˜ê²½ì—ì„œ topìœ¼ë¡œ ìµœëŒ€ 20% cpu ë¶€í•˜ í™•ì¸
top - 06:08:52 up  6:05,  4 users,  load average: 0.00, 0.00, 0.00
Tasks: 153 total,   2 running, 151 sleeping,   0 stopped,   0 zombie
%Cpu(s): 20.3 us,  0.0 sy,  0.0 ni, 79.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :    949.7 total,    190.9 free,    220.8 used,    538.0 buff/cache
MiB Swap:      0.0 total,      0.0 free,      0.0 used.    566.2 avail Mem

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
   3028 root      20   0    3704    128    128 R  19.9   0.0   0:06.22 stress
      1 root      20   0  101864  12408   7928 S   0.0   1.3   0:04.17 systemd

# ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œ mem 200MB ì´ˆê³¼ì‹œ OOMìœ¼ë¡œ ì¸í•´ í„°ì§€ëŠ”ê±° í™•ì¸
root@tuna:/# stress --vm 1 --vm-bytes 198M
stress: info: [128] dispatching hogs: 0 cpu, 0 io, 1 vm, 0 hdd
Killed
root@tuna:/# stress --vm 1 --vm-bytes 199M
stress: info: [130] dispatching hogs: 0 cpu, 0 io, 1 vm, 0 hdd
Killed
root@tuna:/# stress --vm 1 --vm-bytes 200M
stress: info: [132] dispatching hogs: 0 cpu, 0 io, 1 vm, 0 hdd
stress: FAIL: [132] (416) <-- worker 133 got signal 9
stress: WARN: [132] (418) now reaping child worker processes
stress: FAIL: [132] (452) failed run completed in 0s
```

## ì°¸ê³ ìë£Œ

https://stackoverflow.com/questions/44666700/unshare-pid-bin-bash-fork-cannot-allocate-memory

[When do you need a default gateway? - YouTube](https://www.youtube.com/watch?v=hI5L5IxqS-Y)

[[Docker] 12. ìŠ¤í† ë¦¬ì§€ ë“œë¼ì´ë²„(storage driver) (tistory.com)](https://junstar92.tistory.com/170)

https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-memory
