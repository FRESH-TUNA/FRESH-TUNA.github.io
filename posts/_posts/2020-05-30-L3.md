---
layout: post
title: "네트워크 계층 (L3)"
# author: "DONGWON KIM"
# meta: "Springfield"
categories: "Infra"
comments: true
---

## 1. L3가 하는일
네트워크 계층은 라우팅과 포워딩을 통해 호스트간의 패킷 교환을 담당한다.
송신지 네트워크에서 수신지 네트워크로 최적의 경로를 찾는것을 라우팅이라 한다. 라우팅 알고리즘을 통해 최적의 경로를 구해내고 이를 통해 하나의 라우팅 테이블을 만든다. 리우팅 테이블을 통해 입력 링크로 들어온 패킷을 출력 링크로 전달하는 행위를 포워딩이라고 부른다. OSI 7에서의 네트워크계층은 흐름제어를 통해 송신자는 수신자가 허용할수 있을만큼의 데이터만 보내도록 조절하는 역활도 담당하지만 인터넷 네트워크 계층에선 흐름제어를 제공하지 않는다.

## 2. Datagram 방식 (비연결형 서비스)
네트워크 계층의 간소화를 위해서 모든 패킷을 독립적으로 처리하는 패킷 교환 방식이다. 패킷들은 목적지까지 같은 경로나 혹은 다른경로로 전달된다. 포워딩은 목적지의 주소에 따라 결정된다.

## 3. 가상회선방식 (연결 지향형 서비스)
메시지의 모든 패킷이 전송되기 전에 데이터그램을 위한 가상의 경로를 설정한다. 설정후 데이터그램들을 모두 같은 경로로 전송하는 패킷교환기법이다. 포워딩은 패킷의 레이블에 의해 결정된다. 설정단계와 요청패킷을 거쳐 확인응답을 받고 나면 가상회선이 완성된다.

## 4. 목적지 주소 기반 포워딩
일반적으로 사용되는 방식으로 포워딩 테이블을 가진 호스트나 라우터가 필요하다. 호스트가 전송할 패킷이 있거나 라우터가 포워딩할 패킷을 수신할경우 포워딩한다.  주소 집단화를 통해 테이블 엔트리의 갯수를 감소시키고 가장 긴 마스크에서 짧은 마스크의 순서로 정렬되어있다. 지리적 라우팅기법으로 전체 주소공간을 아메리카, 유럽, 아시아, 아프리카 등에 각각 한 개의 블록을 할당한다.

## 5. 라우터
네트워크를 논리적으로 구분해주며 LAN과 WAN의 경계의 역활과 수신한 패킷을 적절한 경로(네트워크)로 전송하는 네트워크계층의 핵심장비이다 . 라우터는 패킷을 받으면, 패킷에 있는 목적지의 IP주소를 보고 미리 설정된 라우팅 테이블을 참조하여 적절한 라우터로 전송한다. 만약 네트워크 외부에 있는 라우터로 전송이 필요하면 기본 게이트웨이로 전송하여 처리한다.  

라우팅 테이블을 관리하는 방법에는 static routing, dynamic routing 기법이 있다. 기업에서는 보통 외부라우터와 접속할때 ISP나 데이터센터 내부의 라우터일뿐이기 때문에 주로 static routing 을 사용한다. dynamic routing은 BGP, OSPF, RIP 등의 기법이 있는데, 외부 라우터와의 접속이 자주 변화할때 사용하면 좋다. 

라우터를 고를때는 상위 회선의 인터페이스와 일치하는 WAN 인터페이스를 가지는것이 중요하다. 그리고 상위 회선의 대역폭보다 높은 인터페이스는 오버스펙이다. throughput은 단위시간당 데이터 전송량을 가리키는데 라우터에 어느정도의 전송속도를 요구할지 결정하며 통신량이 많지 않으면 throughput이 낮은 저가의 라우터로도 충분하다.

최근의 라우터에는 보안기능(특정ip주소나 TCP/UDP 포트번호 이외의 통신 차단)이 탑재되는 경우가 많다. 중간 규모 이하의 사이트에서는 이런 라우터를 사용하는것이 좋지만 대형 규모의 사이트에선 보안장치를 분리하여 운용하는것이 좋다.

라우터는 입력포트, 출력포트, 라우팅 프로세서, 스위칭 패브릭으로 구성되어있다. 입력포트는 라우터의 물리계층과 링크계층의 기능을 담당하며, 프레임을 역캡슐화하여 패킷을 추출하고, 오류검사, 패킷들의 큐를 담당한다. 출력포트는 입력포트와 같은 기능을 역순으로 수행한다.  

호스트에 직접 연결되어있는 라우터를 default 라우터 (first-hop router)라고 부른다. source host의 default router를 source router라고 부르며, destination host의 default router를 destination router라고 부른다. 

라우팅프로세서는 네트워크계층의 기능을 수행하는 핵심적인 장치로, 패킷의 주소를 참조하며 패킷을 전송할 출력 포트번호와 다음 홉(네트워크) 주소를 찾는다(테이블 검색). 최신 라우터는 이를 입력포트에서 작동하도록 하여 신속히 처리하기도 한다. 스위칭 패브릭은 패킷을 입력 큐에서 출력 큐로 전달하는 과정을 말한다. 크로스바 스위치, 반얀 스위치 방식, 배처-반얀 스위치 방식 으로 구성되어있다.

## 6. 라우팅 알고리즘
라우팅 알고리즘은 여러대의 라우터들속에서 그래프 자료구조를 사용해서 가장 좋은 경로를 찾는것이 목적이다. 한 네트워크 전역의 정보를 이용하여 최소 비용의 경로를 찾는 global routing algorithm,  인접한 노드들의 정보를 이용해 최소 비용의 경로를 찾는 decentralized routing algorithm으로 구분할수 있다. 또 네트워크 로드나 토플리지 변화에 동적으로 경로를 바꾸는지의 여부에 따라 static, dynamic으로 분류할수 있으며 혼잡의 정도를 cost에 얼마나 반영하는지의 여부에 따라 load-sensitive로 분류할수 있다.

## 7. Link-State 라우팅 알고리즘
global routing algorithm의 한종류로 각 라우터들은 주변의 링크를 탐색하여 인접한 라우터들을 알아낸후 가중치를 측정한다. 이후 가중치를 담은 LSP 패킷을 네트워크안의 모든 라우터가 브로드케스트하여 공유한다. 각 라우터들은 받은 LSP패킷을 바탕으로 다익스트라 알고리즘이나 프림알고리즘으로 최소 비용 거리를 측정할수 있다. 

## 8. distance vector 라우팅 알고리즘
decentralized routing algorithm의 한종류로 벨만 포드 알고리즘등을 사용하여 직접 인접한 노드들로 부터 얻은 정보를 활용하여 최단 경로를 찾은후 이를 인접한 노드에 전파하여 갱신해준다. Link-State와 달리 iterative, self-terminating, distributed한 특징을 가진다.  

## 9. autonomous system (AS) with routing
네트워크에서 관리하는 라우터의 갯수가 너무 많아 복잡도가 증가하는 현상을 막거나 특정 라우터 그룹에 정책을 적용하기 위해 ISP나 기관이 라우터들을 그룹화한것을 의미한다. 

AS안의 라우터들은 같은 라우팅 알고리즘을 사용하며, 외부의 다른 AS와 통신하기 위한 한개 이상의 라우터를 지정하는데 이를 gateway router라고 부른다. gateway가 여러개인경우 먼저 목적지에서 접근가능한지의 여부를 확인하여 라우팅 테이블을 생성한다. 

AS안의 노드들에대해 라우팅을 진행하는 intra-AS routing protocol (IGP)에는 거리 벡터 알고리즘을 사용하여 라우팅을 진행하는 RIP와 link-state 기반의 OSPF가 있다.

AS간에 라우팅을 진행하는 Inter-AS Routing(EGP)은 이웃한 AS로 부터 reachability 정보를 제공받고 이를 자신이 관리하는 라우터들에 전파하는 역활과 좋은 AS 경로를 찾는 역활을 하며 대표적인 예로 BGP4가 있다.

## 10. 유니캐스트 라우팅
데이터그램의 목적지가 단 하나이면 이것을 유니캐스트 라우팅이라고 한다.  최소비용으로 라우터들을 거쳐서 목적지에 도달하는것이 기본 원리이다.

## 11. 멀티캐스트 라우팅
하나의 발신지에 목적지 그룹이 존재하는 라우팅이다. 다중 유니캐스팅이 총 목적지 수만큼 패킷을 생성하는것과는 다르다. 멀티캐스트는 분산 데이터베이스 접근이나, 원격회의및 원격교육에 유용하게 활용된다.

224.0.0.0/24 은 네트워크 내부에서 사용하기 위한 멀티캐스트 주소이다. 224.0.1.0/24은 서브블록보다 큰 네트워크에서 사용하기 위한 멀티캐스트주소이다. 232.0.0.0/8 소스 지정 멀티캐스트 라우팅으로 소스주소를 같이 지정하여 운용한다. 233.0.0.0/8은 GLOP블록으로 AS 내부에서 사용하기 위한 주소의 범위를 정의한다. 239.0.0.0/8은 관리 범위 블록으로, 인터넷의 특정한 범위에서 사용한다.

## 12. 브로드캐스트 라우팅
하나의 호스트가 인터넷의 모든 호스트에게 패킷을 보내는 라우팅을 의미한다. 일반적으로 거대한 양의 트래픽을 발생시키기때문에 제한적인 범위 내에서 사용한다.

## 13. 터널링과 터널
물리적인 네트워크에 배치한 가상경로를 터널이라고 부르고 터널을 만드는 과정을 터널링이라고 부른다. ssh 터널링을 예로 들면 터널을 오가는 데이터는 암호화되어 전송되기때문에 외부의 공격으로부터 보호받을수 있다. 

```bash
# local port forwarding
ssh -L port_of_client:ip_and_port_of_wish_to_forward server_ip

# remote port forwarding
ssh -R port_of_server:ip_and_port_of_wish_to_forward client_ip
```

다만 터널링을 하게되면 캡슐화를 진행하면서 패킷크기가 원래크기보다 커져 1500바이트를 넘게 될수 있으므로 MTU의 조정이 필요할수도 있다.

## 14. Delay
패킷이 발신지에서 목적지까지 전송될때 필연적으로 지연이 발생한다. 전송지연은 발신지 호스트나 라우터는 패킷의 모든 비트를 순산적으로 동시에 보낼수 없으므로 전송해햐할 비트를 순차적으로 전송하게 되는데 이때 걸리는시간을 의미한다. 전파지연은 1비트가 A지점 부터 B지점까지 전달되는데 걸리는 시간을 의미한다. 처리지연 헤더를 제거하고 오류탐지를 수행한뒤, 출력포트로 패킷을 보내거나 상위계층 프로토콜로 패킷을 전달 하는데 걸리는 시간이다.

예를 들어 100Mbps, 10000bit 패킷을 전송하는데 걸리는 전송지연은 10000/100000000 = 1/10000 sec = 100 마이크로 sec 가 된다. 2000m의 케이블이 있다고 가정할때 1비트가 전달되는데 걸리는시간은 2000/200,000,000 = 10 마이크로 sec이다. 이외에도 라우터에서의 큐 내부의 지연과 전체지연등이 있다.

## 15. Throughput
초당 한 지점을 지나는 비트의 수로 정의 되는것으로 해당 지점의 실질적인 전송률이다.  발신지에서 목적지까지의 경로에서 패킷은 서로 다른 전송률을 가진 다수의 링크를 통과하게 된다.

## 16. PacketLoss
손실되는 패킷의 수는 통신의 성능에 큰 영향을 미친다. 일반적인 유선망에서 패킷 손실은 오버플로우 상황에서 주로 발생하고, 손실은 미미한 수준이다.

## 17. 혼잡제어
혼잡이 발생하기전에 방지하는 open-loop 기법, 혼잡 발생후 그것을 없애주는 역활을 하는 기술이다. closed-loop 기법이다. 

## 18. IPV4
![Image Alt 텍스트](/img/2020/05/30/L3/1599px-IPv4_Packet_-en.svg.png)
네트워크를 구분해주는 식별자를 IP주소 혹은 인터넷주소라고 한다. IPV4는 32비트로 네트워크구분 을해 생성하는 주소의 규격을 말한다.  네트워크계층에서 사용하는 패킷을 데이터그램이라고 한다. 데이터그램은 가변 길이의 패킷으로 헤더와 페이로드로 이루어져 있다.  

IPV4는 32비트의 주소를 사용하므로 주소공간은 2^32가 된다. IP주소를 나타내기 위해서 2진수, 10진수, 16진수등을 사용하지만 10진수를 주로 사용한다.  IP주소는 prefix와 suffix의 계층적구조로 구성되어있으며 prefix는 네트워크를 정의하고, suffix는 노드를 정의해준다. 이를 슬래쉬 표기법이라 불르루며 CIDR 라고도 부른다.

## 19. Classful Addressing
IPV4는 고정된 프리픽스인 클래스A (prefix bits = 8), 클래스B(prefix bits = 16), 클래스C(prefix bits = 24), 클래스D(멀티캐스트), 클래스E를 제공한다.  적절히 주소가 분배되지 않아 주소가 남지 않는 주소고갈현상이 발생하는데 이때 서브네팅 혹은 슈퍼네팅을 통해 해결한다. (장기적인 해결책은 IPV^를 사용하는것이다.) 각 클래스의 프리픽스가 고정되어있기 때문에 주소의 클래스를 쉽게 찾을수 있다.

## 20. Classless Addressing
주소의 프리픽스 부분을 임의로 지정한다. classless 방식의 경우 주소가 주어졌을때 어디까지가 prefix인지 알수 없기 때문에 prefix의 길이를 따로 명시해야한다. 네트워크상의 주소갯수는 2 ^ (32 - prefix bits)가 되고, prefix를 제외한 나머지 비트를 0으로 채우면 본 네트워크 상의 첫번째 주소, 1로 채우면 네트워크 상의 마지막 주소가된다. 이를 마스크를 활용하여 계산하면 다음과 같다.

Number of addresses in the block: N = NOT(mask) + 1

First address: (address) AND (mask)

Last address: (address) OR (NOT mask)

주소블록의 할당은 ICANN이 담당하며 이떼 power of 2의 값으로 기관이 요청한다. 

## 21. 서브넷팅
서브넷팅을 통해 더많은 계층을 임의로 생성하는것이 가능하다. 일정범위의 주소를 가진 기관은 범위를 작은 범위로 나누고 이를 서브네트워크에 할당할수 있다.  마찬가지로 서브네트워크는 다시 여러개의 서브네트워크로 나누는것이 가능하다.

14.24.74.0/24 ~ 14.24.74.255/24로 끝나는 주소블록을 할당받은 기관이 있을때 세 개의 서브넷을 사용하여 주소를 각각 10개, 60개, 120개의 서브블록으로 나누려고 할때 다음과 같이 설계한다.

가장먼저 큰 순서대로 120개의 주소를 할당해보자, power of 2 만큼만 블록을 할당할수 있기때문에 128개의 서브블록이 필요하다. 14.24.74.0/25 를 서브블록으로 만들면 128개를 할당할수 있다. 그러면 이제 14.24.74.128/25 만이 남았다.

다음으로 60개의 주소를 할당하기 위해선 64개의 서브블록이 필요하다. 이를 위해 14.24.74.128/26 을 서브블록으로 만들어 64개를 할당한다. 마지막으로 10개를 할당하기 위해선 16개의 주소블록을 할당해야하기 때문에 14.24.74.11000000/28을 활용한다.

이렇게 되면 남아있는 주소공간은 14.24.74.11010000 ~ 14.24.74.11111111 이 된다. 서브넷들의 상위 블록 프리픽스를 통해 라우팅이 수행된다. 

## 22. 특수주소
this-host 주소는 0.0.0.0/32 블록에 있는 주소로 호스트가 발신지 주소인 자신의 주소를 모를때 사용한다. 0.0.0.0 주소는 listening on all interface라는 의미이기도 하다. 컨테이너 환경에서 제한된 브로드캐스트 주소는 255.255.255.255/32의 주소로 패킷을 전송시, 소속된 네트워크에서 브로드캐스트한다. 라우터는 이패킷을 밖으로 보내지 않고 block 시킨다. 루프백주소는 127.0.0.0/8의 블록은 루프백 주소로써 이 블록내의 주소를 목적지 주소로 가진 패킷은 호스트를 벗어나지 않고 호스트로 다시 돌아온다.

사설주소는 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 169.254.0.0/16의 네가지 블록을 의미하며 사설망에서만 사용하고 인터넷망에서는 허용되지 않는다. 멀티케스트 주소는 224.0.0.0/4로 예약된 블록이다.

## 23. Fragmentaion
네트워크의 프레임은 전달할수 있는 최대 데이터크기를 가지고 있기 때문에, 데이터링크 계층에 전달되기 전에 작은 크기로 분할해야 한다. 이때 최대 전송 단위를 MTU라고 부르며 데이터그램의 전체크기는 이보다 작아야한다.

## 24. IPSec
패킷도청, 패킷변조, IP 스푸핑등의 공격을 막기위한 IP 프로토콜과 결합하여 사용되는 방식이다. 알고리즘과 키를 정의하고 패킷을 암호화한다. 데이터 무결성 검사와 발신지인증을 담당한다. IPsec의 터널모드에서는 도착지/출발지의 데이터그램을 통으로 암호화하므로, 라우터와 도착지를 포함하는 새로운 IP 헤더를 부여한다.

## 25. L2, L3 스위치
네트워크 장비 중 허브(hub)와 스위치(switch, 혹은 스위치 허브)도 다시 말해, 하나의 네트워크 라인에 여러 대의 컴퓨터로 네트워크를 분배해줄수 있는 기능을 제공한다.  L2 스위치 2계층에서 사용되는 스위치로, 프레임이 들어오면 목적지의 MAC주소로 프레임을 스위칭한다. 만약 해당하는 MAC주소가 없다면 LAN전체에 브로드캐스팅 한다.

L3 스위치란 라우터 기능이 추가된 L2 스위치로 볼수있다. 목적지 IP주소를 보고 적절한 포트로 패킷을 전송한다. L3 스위치 내에 해당하는 IP주소가 없으면 기본 게이트웨이 포트로 전송된다.

스위치를 선택할때는 인터페이스의 속도와 포트수를 고려하는것이 우선이다. 스위치는 지능형과 비지능형으로 구분할수 있는데 지능형 스위치는 웹이나 텔넷을 통해 포트설정 변경, 상태및 통신량을 알수 있다. 만약 이런 기능이 필요하다면 지능형 스위치를 선택하는것이 좋다. 

스위치의 성능은 속도를 나타내는 PPS(Packet per second),  용량을 나타내는 BPS(bit per second)로 나타낼수 있다. 와이어 스피드와 논블로킹 (각포트에 이론상 최대통신량 발생)을 지원하면 고성능 스위치라고 볼수 있다. 스위치는 소프트웨어 혹은 하드웨어 방식으로 job을 처리하는데, 고성능이 요구될수록 하드웨어 방식의 중요성이 커진다.

## 26. DHCP
정적 혹은 동적으로 IP 주소를 할당하는 기능을 정의하는 프로토콜이다. AWS나 ISP는 ICANN으로부터 직접 주소의 블록을 할당 받고 작은 기관은 ISP로부터 주소의 블록을 할당받는다. 주소블록이 일단 기관에 할당되면 네트워크 관리자가 개개의 호스트나 라우터에 수동으로 컴퓨터의주소, 마스크(프리픽스), 디폴트 라우터주소, DNS를 할당해야 한다. 이를 자동으로 해주는녀석이 DHCP 이다.

DHCP의 주요 메시지는 discover, offer, request, ack가 있다. 클라이언트는 가장 먼저 discover 메시지를 전송한다. (목적지 IP주소, 목적지 MAC 주소는 브로드캐스트로 설정), 네트워크 안의 DHCP 서버만이 이를 인식하여 목적지 MAC주소는 클라이언트, 목적지 IP주소는 새로운 ip주소의 데이타그램과 프레임을 할당하고, dhcp 서버 ip주소, 할당 ip주소, 서브넷마스크, 디폴트게이트웨이를 메시지에 담아 전송한다. 새로운 정보를 받은 클라이언트는 이 정보들을 사용하겟다는 request메시지를 보내고 서버가 이를 받아 ack를 전송하면 할당과정이 끝나게 된다.

DHCP 서버는 서브넷마다 마련하는것이 일반적이나 여의치 않으면 DHCP릴레이 기능을 활용해 특정 DHCP서버에 전송하는 방법을 의미한다.

## 27. NAT
최근에 SOHO (small office, home office) 환경이 증가하면서 여러 장치를 연결할수 있는 LAN 구축의 필요성이 커졌다. 이를 위해 사설주소와 범용주소의 매핑을 제공하고 동시에 DHCP를 통하여 가상 사설 네트워크를 지원하는 기술이 바로 NAT이다. 

네트워크 내부의 통신을 위해 사설주소를 사용하며 다른 네트워크와의 통신에는 범용 인터넷 주소를 사용할수 있도록 지원한다. NAT 라우터를 통해 나가는 패킷은 발신지 주소를 범용 NAT 주소러 변환해주며 반대의 상황에서는 적절한 사설 주소로 변환해준다. 

## 28. ICMP
네트워크 계층은 일반적으로 오류제어를 담당하지 않기 때문에 오류발생시 원래의 호스트에게 통보할 메커니즘이 없으며, 다른 호스트나 라우터가 동작하고 있는지의 여부를 확인할수 없기때문에 설계된 프로토콜이다.

## 29. IGMP
호스트가 멀티캐스트 구성원을 인접한 스위치 및 라우터에 광고할수 있도록 도와주는 프로토콜이다. 

## 30. 토플로지
2계층 토플로지는 프론트엔드와 백엔드로 나누어 구성한다. 프론트엔드층은 인터넷과 가까운곳에 위치하며 직접공인 IP로 통신하거나 L4 스위치로 중계한다. 백엔드의 경우 프론트엔드를 거쳐서 통신해야하므로 외부로부터의 직접공격을 막을수 있다.

3계층으로 구성할때는 코어계층은 디스트리뷰션 계층에서 오는 통신을 집약하여 인터넷에 연결해준다.디스트리뷰션계층은 코어계층과 엑세스계층간의 통신을 중재한다. 엑세스계층에서는 서버에서 오는 통신을 집약해서 디스트리뷰션 계층으로 연결한다. 

## 31. 차세대 IP
![Image Alt 텍스트](/img/2020/05/30/L3/IPv6_header-en.svg.png)
ipv4의 주소고갈과 단점들로 인하여 IP프로토콜의 새버전인 ipv6를 의미한다. 기본 header는 40바이트에 payload는 65,535 바이트를 붙일수 있다.  주소 체계는 ipv4와 달리 16바이트를 사용한다. 주소표시를 할때는 ipv4와 다르게 16진수로 표시한다. 목적지주소는 유니캐스트, 애니캐스트, 멀티캐스트로 정의할수 있다. 

프로토콜을 바로 바꿀수 없기때문에 이중스택을 통해 IPV4, IPV6를 동시에 지원하도록 하거나, 터널링을 통해 IPV4가 필요한 곳에서만 캡슐화하여 활용하거나, 헤더 변환을 통해 호환성을 지켜야 한다.

## 32. 참고자료
1. https://en.wikipedia.org/wiki/IPv4#/media/File:IPv4_Packet_-en.svg

2. https://en.wikipedia.org/wiki/IPv6#/media/File:IPv6_header-en.svg

3. https://www.amazon.com/Computer-Networking-Top-Down-Approach-7th/dp/0133594149#:~:text=Unique%20among%20computer%20networking%20texts,down%20toward%20the%20physical%20layer%2C
