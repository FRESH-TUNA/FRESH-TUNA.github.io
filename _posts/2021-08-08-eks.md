---
layout: post
title: "기존 App을 여러 service로 분리하여 EKS에 배포해보기"
author: "DONGWON KIM"
meta: "Springfield"
categories: "Infra"
comments: true
---
## 1. 개요
Amazon EKS는 자체 Kubernetes 컨트롤 플레인이나 작업자 노드를 설치 및 운영할 필요 없이 AWS에서 Kubernetes를 손쉽게 실행할 수 있도록 지원하는 관리형 서비스이다.

EKS 서비스에 대해 알아가면서 2년전에 멋쟁이사자처럼 해커톤에서 개발했던 풀꽃길 api 서비스를 MSA 아키텍쳐의 형태로 바꾸어보면 좋을것 같다는 생각이 들었다. 그래서 관련자료들을 찾아보니 하나의 app을 통해 이루어지는 서비스에서 가장 먼저 인증 기능을 분리하는 예제가 많았다. 그래서 이번 프로젝트에서는 풀꽃길 api에서 인증 기능을 분리하고, 이를 EKS를 통해 배포해보았다.
<br/><br/>

## 2. 기존 프로젝트를 인증, 앱 프로젝트로 분리, 도커 이미지
기존에는 하나의 프로젝트에서 모든 요청을 처리했지만, 이제는 이를 인증, 앱 프로젝트로 분리하여 각각의 모듈에서 요청을 처리하도록 개발해야 한다.
따라서 가장 먼저 기존의 코드를 두개 프로젝트로 분리시키고 필요로 하는 파이썬 라이브러리를 각각 조사하여 새로 requirements.txt를 작성해주었다.

<pre>
<code>
# APP image Dockerfile
FROM lunacircle4/python:3.8.1
WORKDIR /app

RUN apt update \
    && apt install -y postgresql postgresql-contrib libpq-dev supervisor zlib1g-dev libjpeg-dev       
    && rm -rf /var/lib/apt/lists/* 
    
COPY requirements.txt ./
RUN pip3 -v --no-cache-dir install -r requirements.txt && rm -rf requirements.txt

COPY . .
RUN cp ./supervisord.conf /etc/supervisor/conf.d

ENTRYPOINT ["supervisord"]
</code>
</pre>

<pre>
<code>
# Auth image Dockerfile
FROM lunacircle4/python:3.8.1
WORKDIR /app

RUN apt update \
    && apt install -y postgresql postgresql-contrib libpq-dev supervisor zlib1g-dev libjpeg-dev       
    && rm -rf /var/lib/apt/lists/* 
    
COPY requirements.txt ./
RUN pip3 -v --no-cache-dir install -r requirements.txt && rm -rf requirements.txt

COPY . .
RUN cp ./supervisord.conf /etc/supervisor/conf.d

ENTRYPOINT ["supervisord"]
```
프로젝트도 별개이므로 서비스를 위한 컨테이너 이미지도 따로 만들어 주어야 한다. 이를 위해 Auth, APP을 위한 Dockerfile을 따로 작성해주었다.
</code>
</pre>
