I"¸(<h2 id="0-ì„œë¡ ">0. ì„œë¡ </h2>

<h2 id="1-ë ˆì§€ìŠ¤íŠ¸ë¦¬ë€">1. ë ˆì§€ìŠ¤íŠ¸ë¦¬ë€</h2>

<h2 id="2-harborë€">2. Harborë€</h2>

<h2 id="3-harbor-registry-êµ¬ì¶•ì„-ìœ„í•œ-ì¤€ë¹„">3. harbor registry êµ¬ì¶•ì„ ìœ„í•œ ì¤€ë¹„</h2>
<h3 id="1-ec2-ì¸ìŠ¤í„´ìŠ¤">1. ec2 ì¸ìŠ¤í„´ìŠ¤</h3>
<p>Harbor ê³µì‹ github ë¬¸ì„œì— ë”°ë¥´ë©´ ë‹¤ìŒê³¼ ê°™ì€ pre-requirementsë“¤ì´ í•„ìš”í•˜ë‹¤.
<img src="/img/2020/03/11/Private-Registry/requirements.png" alt="Image Alt í…ìŠ¤íŠ¸" /></p>

<p>í•˜ì§€ë§Œ ë‚˜ëŠ” í˜¼ì ê³µë¶€í•˜ëŠ” ëª©ì ìœ¼ë¡œ ë§Œë“¤ê¸°ë„í•˜ê³ , ìŠ¤í† ë¦¬ì§€ëŠ” ì–´ì°¨í”¼ s3ë¥¼ ì‚¬ìš©í• ê²ƒì´ê¸° ë•Œë¬¸ì— 
Amazon Linux 2 AMI ê¸°ë°˜ì˜ t2.micro ì¸ìŠ¤í„´ìŠ¤ í•œëŒ€ë¥¼ ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ìƒì„±í•˜ì˜€ë‹¤. ì¸ìŠ¤í„´ìŠ¤ì— í•„ìš”í•œ ë³´ì•ˆê·¸ë£¹ì˜ inbound ì„¤ì •ì€ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•´ì£¼ì—ˆë‹¤.
<img src="/img/2020/03/11/Private-Registry/security_group.png" alt="Image Alt í…ìŠ¤íŠ¸" /></p>

<h3 id="2-ì¸ì¦ì„œ">2. ì¸ì¦ì„œ</h3>
<p>ë„ì»¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì˜ ë³´ì•ˆ ì—°ê²°ì„ ìœ„í•´ì„œ ë°˜ë“œì‹œ ì¸ì¦ì„œ ë°œê¸‰ì´ í•„ìš”í•˜ë‹¤.
AWS Certificate Managerì— ì ‘ì†í•˜ì—¬ ë‚´ê°€ ì›í•˜ëŠ” ë„ë©”ì¸ ì´ë¦„ì„ ë°”íƒ•ìœ¼ë¡œ ì¸ì¦ì„œë¥¼ ìƒì„±í•´ì£¼ì—ˆë‹¤.
ì˜ˆë¥¼ ë“¤ì–´ ë‚´ê°€ ì†Œìœ í•˜ê³  ìˆëŠ” ë„ë©”ì¸ì´ hello.comì¸ë° ì›í•˜ëŠ” ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë„ë©”ì¸ ì´ë¦„ì´ registry.hello.comì´ë¼ë©´ ì¸ì¦ì„œ ìƒì„±ì‹œ 
ë„ë©”ì¸ ì´ë¦„ì„ â€˜registry.hello.comâ€™ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë°œê¸‰í•´ì•¼ í•œë‹¤.
ë‚´ê°€ ê°€ì§€ê³  ìˆëŠ” ë„ë©”ì¸ì€ â€˜knufesta2019.deâ€™ ì´ë¯€ë¡œ â€˜myregistry.knufesta2019.deâ€™ ë¡œ ìƒì„±í•´ì£¼ì—ˆë‹¤.</p>

<h3 id="3-ë¡œë“œ-ë°¸ëŸ°ì„œ">3. ë¡œë“œ ë°¸ëŸ°ì„œ</h3>
<p>í–¥í›„ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì˜ í™•ì¥ì„±ì„ ê³ ë ¤í•´ì„œ ec2ì™€ route53 ì‚¬ì´ì— ë¡œë“œë°¸ëŸ°ì„œë¥¼ í•œëŒ€ ë‘ê¸°ë¡œ ìƒê°í–ˆë‹¤.
Application íƒ€ì…ì˜ ë¡œë“œë°¸ëŸ°ì„œë¥¼ í•˜ë‚˜ ë§Œë“¤ê³  ë¦¬ìŠ¤ë„ˆë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•´ì£¼ì—ˆë‹¤.
https(443 port) ì—°ê²°ì„ ìœ„í•´ í•„ìš”í•œ ì¸ì¦ì„œëŠ” ìœ„ì˜ ACMì—ì„œ ë§Œë“ ê²ƒì„ ì‚¬ìš©í•˜ì˜€ë‹¤.</p>

<p>awsëŠ” ì—¬ëŸ¬ ì¢…ë¥˜ì˜ ë¡œë“œë°¸ëŸ°ì„œë¥¼ ì œê³µí•˜ëŠ”ë° ê·¸ì¤‘ì— ë‚˜ëŠ” Application íƒ€ì…ì˜ ë¡œë“œë°¸ëŸ°ì„œë¥¼ ì‚¬ìš©í•˜ì˜€ìœ¼ë©°
ë¡œë“œë°¸ëŸ°ì„œì˜ ëŒ€ìƒê·¸ë£¹ì— ì•„ê¹Œ ìƒì„±í–ˆë˜ ec2ë¥¼ ì¶”ê°€ì‹œì¼œ ì£¼ì—ˆë‹¤. ê·¸ë¦¬ê³  ëŒ€ìƒê·¸ë£¹ì˜ 443ë²ˆ í¬íŠ¸ë¡œë°›ì•„ì„œ ec2ì˜ 443ë²ˆ í¬íŠ¸ë¡œ ë³´ë‚´ë„ë¡ ì„¤ì •í•˜ì˜€ë‹¤.</p>

<h3 id="4-route53-ì—°ë™">4. Route53 ì—°ë™</h3>
<p>Route53ì€ awsê°€ ì œê³µí•˜ëŠ” DNS ì›¹ì„œë¹„ìŠ¤ì´ë‹¤. ë„ë©”ì¸ì„ êµ¬ë§¤í•˜ê±°ë‚˜ ë“±ë¡, ë¼ìš°íŒ…ì„ í• ìˆ˜ ìˆëŠ” ì¬ë¯¸ìˆëŠ” ì¹œêµ¬ì¸ë°,
ë‚´ê°€ êµ¬ë§¤í–ˆë˜ ë„ë©”ì¸ì„ í™œìš©í•˜ì—¬ ë¡œë“œë°¸ëŸ°ì„œì™€ ì—°ê²°ì‹œí‚¤ëŠ” ì‘ì—…ì„ ì§„í–‰í–ˆë‹¤.</p>

<h3 id="4-s3-ë²„ì¼“">4. s3 ë²„ì¼“</h3>
<p>ë„ì»¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ëŠ” ì‘ì—…ìë“¤ì´ í‘¸ì‹œ ìš”ì²­ì„ ë³´ë‚¸ ì´ë¯¸ì§€ë¥¼ ì €ì¥í• ìˆ˜ ìˆëŠ” ìŠ¤í† ë¦¬ì§€ê°€ í•„ìš”í•˜ë‹¤.
ë‚˜ëŠ” ec2ì— ì—°ê²°ë˜ì–´ìˆëŠ” EBS ë³¼ë¥¨ì´ ì•„ë‹ˆë¼ s3 ìŠ¤í† ë¦¬ì§€ë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ê¸° ë•Œë¬¸ì— s3 ë²„ì¼“ í•˜ë‚˜ë¥¼ ë§Œë“¤ì—ˆë‹¤.</p>

<h3 id="5-s3-ì ‘ê·¼ì„-ìœ„í•œ-iam-key-ìƒì„±">5. s3 ì ‘ê·¼ì„ ìœ„í•œ IAM key ìƒì„±</h3>
<p>harbor registry ì ‘ê·¼ì„ ìœ„í•´ì„  s3ì— ì½ê¸°, ì“°ê¸° ê¶Œí•œì„ ê°€ì§„ programmable keyê°€ í•„ìš”í•˜ë‹¤.
IAM ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ S3Fullaccess ê¶Œí•œì„ ê°€ì§„ ê³„ì •ì„ í•˜ë‚˜ ìƒì„±í•˜ì—¬ credentialì„ ì•ˆì „í•œê³³ì— ì˜ ì €ì¥í•´ë‘ì—ˆë‹¤.
<img src="/img/2020/03/11/Private-Registry/iam.png" alt="Image Alt í…ìŠ¤íŠ¸" /></p>

<h2 id="3-harbor-registry-êµ¬ì¶•í•˜ê¸°">3. harbor registry êµ¬ì¶•í•˜ê¸°</h2>
<h3 id="1-ec2-ì¸ìŠ¤í„´ìŠ¤ì—-docker-docker-compose-ì„¤ì¹˜">1. ec2 ì¸ìŠ¤í„´ìŠ¤ì— docker, docker-compose ì„¤ì¹˜</h3>
<p>harborë¥¼ êµ¬ë™ì‹œí‚¤ê¸° ìœ„í•´ì„  dockerì™€ docker-composeê°€ í•„ìš”í•˜ë‹¤.
amazon linux AMI 2 ë²„ì „ ê¸°ì¤€ìœ¼ë¡œ í•„ìš”í•œ ëª…ë ¹ì–´ë¥¼ ì‘ì„±í•´ë³´ì•˜ë‹¤.
ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì°¨ë¡€ë¡œ ì‹¤í–‰í•´ì¤€ë‹¤ìŒì— sshì— ì¬ì ‘ì† í•´ì£¼ë©´ ëœë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>amazon-linux-extras <span class="nb">install</span> <span class="nt">-y</span> docker

<span class="nb">sudo </span>service docker start

<span class="nb">sudo </span>usermod <span class="nt">-a</span> <span class="nt">-G</span> docker ec2-user

docker version

<span class="nb">sudo </span>curl <span class="nt">-L</span> https://github.com/docker/compose/releases/download/1.22.0/docker-compose-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-s</span><span class="si">)</span>-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span> <span class="nt">-o</span> /usr/local/bin/docker-compose

<span class="nb">sudo chmod</span> +x /usr/local/bin/docker-compose

<span class="nb">sudo ln</span> <span class="nt">-s</span> /usr/local/bin/docker-compose /usr/bin/docker-compose

docker-compose version
</code></pre></div></div>

<h3 id="2-harbor-ì„¤ì¹˜-í”„ë¡œê·¸ë¨-ë‹¤ìš´ë¡œë“œ-ë°-ì••ì¶•í’€ê¸°">2. harbor ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ë‹¤ìš´ë¡œë“œ ë° ì••ì¶•í’€ê¸°</h3>
<p>https://github.com/goharbor/harbor/releases<br />
harbor githubì— ì ‘ì†í•´ì„œ ìµœì‹  release ì„¤ì¹˜ìš© íŒŒì¼ ë§í¬ì„ ì°¾ì€í›„ wgetìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ í•´ì¤€ë‹¤.
<img src="/img/2020/03/11/Private-Registry/harbor_release.png" alt="Image Alt í…ìŠ¤íŠ¸" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://github.com/goharbor/harbor/releases/download/v1.10.1/harbor-offline-installer-v1.10.1.tgz

<span class="nb">tar </span>xvzf harbor-offline-installer-v1.10.1.tgz
</code></pre></div></div>

<p>ì´ê³¼ì •ì´ ëë‚˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ í´ë” êµ¬ì¡°ê°€ ë ê²ƒì´ë‹¤. harborí´ë” ì•ˆìœ¼ë¡œ ì´ë™í•´ì£¼ì
<img src="/img/2020/03/11/Private-Registry/harbor_download.png" alt="Image Alt í…ìŠ¤íŠ¸" /></p>

<h3 id="3-opensslì„-í™œìš©í•œ-ì¸ì¦ì„œ-ë°œê¸‰">3. opensslì„ í™œìš©í•œ ì¸ì¦ì„œ ë°œê¸‰</h3>
<p>harborë¥¼ httpsë¡œ ì ‘ê·¼í• ë•Œ í•„ìš”í•œ ì¸ì¦ì„œë¥¼ ë°œê¸‰í•´ì£¼ëŠ” ê³¼ì •ì´ í•„ìš”í•˜ë‹¤.
ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ca.key, ca.crt íŒŒì¼ì„ ìƒì„±í•´ì£¼ì
-subj ì˜µì…˜ì€ ê°ìì˜ ìƒí™©ì— ë§ê²Œ ì ì ˆíˆ ìˆ˜ì •í•´ì„œ ì ìš©í•˜ë©´ ëœë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl genrsa <span class="nt">-out</span> ca.key 4096

openssl req <span class="nt">-x509</span> <span class="nt">-new</span> <span class="nt">-nodes</span> <span class="nt">-sha512</span> <span class="nt">-days</span> 3650 <span class="se">\</span>
  <span class="nt">-subj</span> <span class="s2">"/C=KR/ST=Seoul/L=Seoul/O=Org/OU=Registry/CN=myregistry.knufesta2019.de"</span> <span class="se">\</span>
  <span class="nt">-key</span> ca.key <span class="se">\</span>
  <span class="nt">-out</span> ca.crt
</code></pre></div></div>

<h3 id="4-harboryml-ìˆ˜ì •">4. harbor.yml ìˆ˜ì •</h3>
<p>harbor.ymlì€ harbor êµ¬ì¶•ì‹œ í•„ìš”ë¡œ í•˜ëŠ” ì„¤ì •ë“¤ì´ ë“¤ì–´ìˆëŠ” íŒŒì¼ì´ë‹¤.
hostnameì„ ë³¸ì¸ì˜ ì›í•˜ëŠ” ë„ë©”ì¸ìœ¼ë¡œ ì„¤ì •í•´ì£¼ê³ , ì•„ê¹Œ s3ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ ë°œê¸‰ë°›ì•˜ë˜ credentialsë¥¼ ë„£ì–´ì£¼ê³ 
https ì„¤ì •ë„ í•´ì£¼ë„ë¡ í•˜ì. certificate, private_keyëŠ” ë°©ê¸ˆ ë°œê¸‰ëœ ca.key, ca.crtì˜ ì ˆëŒ€ê²½ë¡œë¥¼ ë„£ì–´ì£¼ì</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hostname: myregistry.knufesta2019.de

storage_service:
  s3:
    accesskey: xxxxxxxxxxxxxxxxxxxxxxxxxxxx
    secretkey: xxxxxxxxxxxxxxxxxxxxxxxxxxxx
    region: ap-southeast-1
    bucket: tuna-registry-test

https:
  port: 443
  certificate: /home/ec2-user/harbor/ca.crt
  private_key: /home/ec2-user/harbor/ca.key
</code></pre></div></div>

<h2 id="10-harbor-ì„¤ì¹˜">10. Harbor ì„¤ì¹˜</h2>
<p>ë‹¤ìŒëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì—¬ Harbor ì„¤ì¹˜ë¥¼ ì§„í–‰í•˜ë©´ ëœë‹¤.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> ./install.sh
</code></pre></div></div>
<p>harbor ì„¤ì¹˜ì— ì„±ê³µí•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ í™”ë©´ì´ ëœ¬ë‹¤.
<img src="/img/2020/03/11/Private-Registry/success.png" alt="Image Alt í…ìŠ¤íŠ¸" /></p>

<p>ë¨¼ì € ë‚´ê°€ ì •í–ˆë˜ ë„ë©”ì¸ (myregistry.knufesta2019.de)ìœ¼ë¡œ ì ‘ì†ë˜ëŠ”ì§€ í™•ì¸í•´ë³´ì
<img src="/img/2020/03/11/Private-Registry/harbor.png" alt="Image Alt í…ìŠ¤íŠ¸" /></p>

<p>ê·¸ë¦¬ê³  ì•„ì´ë””ë¡œ admin, íŒ¨ìŠ¤ì›Œë“œë¡œ Harbor12345 (ê¸°ë³¸ê³„ì •)ì„ ì…ë ¥í•´ì„œ ë¡œê·¸ì¸ ë˜ë©´ ì„±ê³µì´ë‹¤.
Project ë©”ë‰´ë¥¼ ë“¤ì–´ê°€ì„œ ì›í•˜ëŠ” organizationì„ ì¶”ê°€í•´ì£¼ì
ex) organization_1/image:tag, organization_2/image:tag â€¦
<img src="/img/2020/03/11/Private-Registry/project.png" alt="Image Alt í…ìŠ¤íŠ¸" /></p>

<h2 id="12-harbor-ë ˆì§€ìŠ¤íŠ¸ë¦¬ì—-push-í•´ë³´ê¸°">12. Harbor ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— push í•´ë³´ê¸°</h2>

<p>ë¨¼ì € ìš°ë¦¬ê°€ êµ¬ì¶•í•œ registryì— ë¡œê·¸ì¸í•œë‹¤.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Username: admin</span>
<span class="c">#Password: xxxxxxxx (ì„¤ì •í•œ íŒ¨ìŠ¤ì›Œë“œ)</span>
docker login myregistry.knufesta2019.de
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  ë¡œì»¬ì— ê°€ì§€ê³  ìˆë˜ ì´ë¯¸ì§€ë¥¼ ìš°ë¦¬ê°€ ë§Œë“  ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œí• ìˆ˜ ìˆë„ë¡ tagging í•œë‹¤.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Username: admin</span>
<span class="c">#Password: xxxxxxxx (ì„¤ì •í•œ íŒ¨ìŠ¤ì›Œë“œ)</span>
docker login myregistry.knufesta2019.de
docker tag myimage:hoho myregistry.knufesta2019.de/organization/myimage:hoho
</code></pre></div></div>

<p>taggingì´ ëë‚˜ë©´ pushê°€ ì˜ ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push myregistry.knufesta2019.de/organization/myimage:hoho
</code></pre></div></div>

<h2 id="13-harbor-ë ˆì§€ìŠ¤íŠ¸ë¦¬ì—-pull-í•´ë³´ê¸°">13. Harbor ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— pull í•´ë³´ê¸°</h2>
<p>pull í…ŒìŠ¤íŠ¸ìš© ì´ë¯¸ì§€ë¥¼ docker hubì—ì„œ ê³¨ë¼ì„œ ë°›ì•„ì£¼ë„ë¡ í•˜ì.
ê·¸ë¦¬ê³  ìš°ë¦¬ê°€ ë§Œë“  ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— push í•˜ê¸° ìœ„í•´ì„œ tagging í•´ë³´ì</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull mariadb:latest
docker tag mariadb:latest myregistry.knufesta2019.de/organization/mariadb:latest
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push myregistry.knufesta2019.de/organization/mariadb:latest
</code></pre></div></div>

:ET