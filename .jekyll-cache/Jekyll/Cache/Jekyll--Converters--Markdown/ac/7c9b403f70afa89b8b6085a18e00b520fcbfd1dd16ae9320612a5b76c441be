I"/<h2 id="0-서론">0. 서론</h2>
<p>CI/CD 프로세스
레지스트리란 빌드된 이미지를 관리하는 서비스이다. 대표적으로 우리가 가장 많이 사용하는 docker hub, AWS ECR 등의 서비스가 있다.
docker hub의 경우 무료로 사용할수 있지만, 배포된 이미지가 공개 되기 때문에 누구나 다운로드 해서 받아볼수 있는 단점을 가지고 있다.
이를 위해선 docker hub의 유료 플랜을 이용하거나 ECR등의 서비스를 이용해 이미지를 저장해보는 방법이 있지만, 이 글에선 aws ec2, s3
서비스와 오픈소스 레지스트리 서비스인 “Harbor”를 활용하여 직접 레지스트리를 구축해보자 한다.</p>

<h2 id="2-harbor란">2. Harbor란</h2>

<h2 id="3-harbor-registry-구축-준비">3. harbor registry 구축 준비</h2>
<h3 id="1-ec2-인스턴스-생성">1. ec2 인스턴스 생성</h3>
<p>Amazon Elastic Compute Cloud(EC2)는 컴퓨팅 엔진 (원하는 연산 능력을 가진 컴퓨터)을 제공해주는 서비스이다.
harbor registry를 동작 시키기 위해선 CPU, RAM, STORAGE등의 인프라가 필요한데 이를 위해 ec2 인스턴스 한대가 필요하다.
Harbor 공식 github 문서에 따르면 다음과 같은 pre-requirements들이 필요하다.
<img src="/img/2020/03/11/Private-Registry/requirements.png" alt="Image Alt 텍스트" /></p>

<p>하지만 테스트 용도의 레지스트리 구축이며, 도커 이미지가 실제로 저장되는 스토리지는 어차피 s3를 사용할것이기 때문에 
Amazon Linux 2 AMI 기반의 t2.micro 인스턴스 한대를 기본 옵션으로 생성하였다. 인스턴스에 필요한 보안그룹의 inbound 설정은 다음과 같이 설정해주었다.
<img src="/img/2020/03/11/Private-Registry/security_group.png" alt="Image Alt 텍스트" /></p>

<h3 id="2-s3-버켓-생성">2. s3 버켓 생성</h3>
<p>모든 레지스트리들은 이미지를 저장하기 위한 스토리지가 필요하다.
AWS가 제공하는 스토리지 서비스는 EBS, EFS, S3 등이 있는데, 이중에 나는 s3를 선택하여 버켓 하나를 생성하였다.
ec2의 디폴트 스토리지는 EBS는 속도가 빠르지만 비용이 s3에 비해 많이 들고, 스케일 업이 어려운 단점이 있가 때문이다.</p>

<h3 id="3-인증서-발급">3. 인증서 발급</h3>
<p>도커 레지스트리의 보안 연결을 위해서 반드시 인증서 발급이 필요하다.
AWS Certificate Manager에 접속하여 내가 원하는 도메인 이름을 바탕으로 인증서를 생성해주었다.
예를 들어 내가 소유하고 있는 도메인이 hello.com인데 원하는 레지스트리 도메인 이름이 registry.hello.com이라면 인증서 생성시 
도메인 이름을 ‘registry.hello.com’으로 설정하여 발급해야 한다.</p>

<h3 id="4-로드-밸런서-생성">4. 로드 밸런서 생성</h3>
<p>향후 레지스트리의 확장성을 고려해서 ec2와 route53 사이에 로드밸런서를 한대 생성하였다.
https(443 port) 연결을 위해 필요한 인증서는 위의 ACM에서 만든것을 사용하였다.</p>

<p>aws는 여러 종류의 로드밸런서를 제공하는데 그중에 나는 Application 타입의 로드밸런서를 생성하였다.
로드밸런서의 대상그룹에 아까 생성했던 ec2를 추가시킨후, 대상그룹의 443번 포트로 요청을 받으면 ec2의 443번 포트로 보내도록 설정하였다.</p>

<h3 id="5-route53-으로-도메인과-로드밸런서-연동하기">5. Route53 으로 도메인과 로드밸런서 연동하기</h3>
<p>Route53은 aws가 제공하는 DNS 웹서비스이다. 도메인을 구매하거나 등록, 라우팅을 할수 있는 재미있는 친구인데
내가 구매했던 도메인을 활용하여 생성했던 로드밸런서와 연결시키는 작업을 진행했다.</p>

<h3 id="6-s3-접근을-위한-iam-key-생성">6. s3 접근을 위한 IAM key 생성</h3>
<p>harbor registry 접근을 위해선 s3에 읽기, 쓰기 권한을 가진 programmable key가 필요하다.
IAM 서비스를 이용하여 S3Fullaccess 권한을 가진 계정을 하나 생성하여 credential정보롤 기록해두었다.
<img src="/img/2020/03/11/Private-Registry/iam.png" alt="Image Alt 텍스트" /></p>

<h2 id="3-harbor-registry-구축하기">3. harbor registry 구축하기</h2>
<h3 id="1-ec2-인스턴스에-docker-docker-compose-설치">1. ec2 인스턴스에 docker, docker-compose 설치</h3>
<p>harbor를 구동시키기 위해선 docker와 docker-compose가 필요하다.
amazon linux AMI 2 버전 기준으로 필요한 명령어를 작성해보았다.
아래 명령어를 차례로 실행해준다음에 ssh에 재접속 해주면 된다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>amazon-linux-extras <span class="nb">install</span> <span class="nt">-y</span> docker

<span class="nb">sudo </span>service docker start

<span class="nb">sudo </span>usermod <span class="nt">-a</span> <span class="nt">-G</span> docker ec2-user

docker version

<span class="nb">sudo </span>curl <span class="nt">-L</span> https://github.com/docker/compose/releases/download/1.22.0/docker-compose-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-s</span><span class="si">)</span>-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span> <span class="nt">-o</span> /usr/local/bin/docker-compose

<span class="nb">sudo chmod</span> +x /usr/local/bin/docker-compose

<span class="nb">sudo ln</span> <span class="nt">-s</span> /usr/local/bin/docker-compose /usr/bin/docker-compose

docker-compose version
</code></pre></div></div>

<h3 id="2-harbor-설치-프로그램-다운로드-및-압축풀기">2. harbor 설치 프로그램 다운로드 및 압축풀기</h3>
<p>https://github.com/goharbor/harbor/releases<br />
harbor github에 접속해서 최신 release 설치용 파일 링크을 찾은후 wget으로 다운로드 해준다.
<img src="/img/2020/03/11/Private-Registry/harbor_release.png" alt="Image Alt 텍스트" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://github.com/goharbor/harbor/releases/download/v1.10.1/harbor-offline-installer-v1.10.1.tgz

<span class="nb">tar </span>xvzf harbor-offline-installer-v1.10.1.tgz
</code></pre></div></div>

<p>이과정이 끝나면 다음과 같은 폴더 구조가 될것이다. harbor폴더 안으로 이동해주자
<img src="/img/2020/03/11/Private-Registry/harbor_download.png" alt="Image Alt 텍스트" /></p>

<h3 id="3-openssl을-활용한-인증서-발급">3. openssl을 활용한 인증서 발급</h3>
<p>harbor를 https로 접근할때 필요한 인증서를 발급해주는 과정이 필요하다.
다음 명령어를 입력하여 ca.key, ca.crt 파일을 생성해주자
-subj 옵션은 각자의 상황에 맞게 적절히 수정해서 적용하면 된다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl genrsa <span class="nt">-out</span> ca.key 4096

openssl req <span class="nt">-x509</span> <span class="nt">-new</span> <span class="nt">-nodes</span> <span class="nt">-sha512</span> <span class="nt">-days</span> 3650 <span class="se">\</span>
  <span class="nt">-subj</span> <span class="s2">"/C=KR/ST=Seoul/L=Seoul/O=Org/OU=Registry/CN=myregistry.knufesta2019.de"</span> <span class="se">\</span>
  <span class="nt">-key</span> ca.key <span class="se">\</span>
  <span class="nt">-out</span> ca.crt
</code></pre></div></div>

<h3 id="4-harboryml-수정">4. harbor.yml 수정</h3>
<p>harbor.yml은 harbor 구축시 필요로 하는 설정들이 들어있는 파일이다.
hostname을 본인의 원하는 도메인으로 설정해주고, 아까 s3에 접근하기 위해 발급받았던 credentials를 넣어주고
https 설정도 해주도록 하자. certificate, private_key는 방금 발급된 ca.key, ca.crt의 절대경로를 넣어주자</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hostname: myregistry.knufesta2019.de

storage_service:
  s3:
    accesskey: xxxxxxxxxxxxxxxxxxxxxxxxxxxx
    secretkey: xxxxxxxxxxxxxxxxxxxxxxxxxxxx
    region: ap-southeast-1
    bucket: tuna-registry-test

https:
  port: 443
  certificate: /home/ec2-user/harbor/ca.crt
  private_key: /home/ec2-user/harbor/ca.key
</code></pre></div></div>

<h2 id="10-harbor-설치">10. Harbor 설치</h2>
<p>다음명령어를 입력하여 Harbor 설치를 진행하면 된다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> ./install.sh
</code></pre></div></div>
<p>harbor 설치에 성공하면 다음과 같은 화면이 뜬다.
<img src="/img/2020/03/11/Private-Registry/success.png" alt="Image Alt 텍스트" /></p>

<p>먼저 내가 정했던 도메인 (myregistry.knufesta2019.de)으로 접속되는지 확인해보자.
다음 화면이 나온다면 harbor 구축의 큰산을 넘은것이다.
<img src="/img/2020/03/11/Private-Registry/harbor.png" alt="Image Alt 텍스트" /></p>

<p>그리고 아이디로 admin, 패스워드로 Harbor12345 (기본계정)을 입력해서 로그인 되면 성공이다.
로그인이후 admin 계정의 기본 패스워드를 빠르게 바꿔주자
<img src="/img/2020/03/11/Private-Registry/main.png" alt="Image Alt 텍스트" /></p>

<p>Project 메뉴를 들어가서 원하는 organization을 추가해주자
ex) organization_1/image:tag, organization_2/image:tag …
<img src="/img/2020/03/11/Private-Registry/project.png" alt="Image Alt 텍스트" /></p>

<h2 id="12-harbor-레지스트리에-push-해보기">12. Harbor 레지스트리에 push 해보기</h2>
<p>먼저 우리가 구축한 registry에 로그인한다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Username: admin</span>
<span class="c">#Password: xxxxxxxx (설정한 패스워드)</span>
docker login myregistry.knufesta2019.de
</code></pre></div></div>

<p>그리고 로컬에 가지고 있던 이미지를 우리가 만든 레지스트리에 푸시할수 있도록 tagging 한다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Username: admin</span>
<span class="c">#Password: xxxxxxxx (설정한 패스워드)</span>
docker login myregistry.knufesta2019.de
docker tag myimage:hoho myregistry.knufesta2019.de/organization/myimage:hoho
</code></pre></div></div>

<p>tagging이 끝나면 push가 잘 되는지 확인한다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push myregistry.knufesta2019.de/organization/myimage:hoho
</code></pre></div></div>

<h2 id="13-harbor-레지스트리에-pull-해보기">13. Harbor 레지스트리에 pull 해보기</h2>
<p>pull 테스트용 이미지를 docker hub에서 골라서 받아주도록 하자.
그리고 우리가 만든 레지스트리에 push 하기 위해서 tagging 해보자</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull mariadb:latest
docker tag mariadb:latest registry.knufesta2019.de/organization/mariadb:latest
</code></pre></div></div>

<p>tagging이 끝나면 우리가 만든 레지스트리에 푸시해보자</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push myregistry.knufesta2019.de/organization/mariadb:latest
</code></pre></div></div>

<p>푸시가 완료되었다면 로컬에 있는 이미지를 지우고 다시 풀을 받아보자
풀이 정상적으로 완료된다면 성공이다!</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push myregistry.knufesta2019.de/organization/mariadb:latest
</code></pre></div></div>
:ET